"use strict";(self.webpackChunkcell_monitor=self.webpackChunkcell_monitor||[]).push([[208],{208:(e,t,s)=>{s.r(t),s.d(t,{default:()=>E});var o,i=s(586),n=s(715),r=s(531),a=s(361);!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"}(o||(o={}));class l{constructor(e={}){this.isDevelopment=this.detectDevelopmentMode(),this.config={level:this.isDevelopment?o.DEBUG:o.ERROR,prefix:"[CellMonitor]",enabledInProduction:!1,...e}}detectDevelopmentMode(){try{return"undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||null!==document.querySelector("[data-jupyter-widgets-version]"))}catch(e){return!1}}shouldLog(e){return this.isDevelopment||this.config.enabledInProduction?e<=this.config.level:e===o.ERROR}formatMessage(e,t,...s){const o=(new Date).toISOString().split("T")[1].split(".")[0];return[`${this.config.prefix}[${e}][${o}]`,t,...s]}error(e,...t){this.shouldLog(o.ERROR)&&console.error(...this.formatMessage("ERROR",e,...t))}warn(e,...t){this.shouldLog(o.WARN)&&console.warn(...this.formatMessage("WARN",e,...t))}info(e,...t){this.shouldLog(o.INFO)&&console.info(...this.formatMessage("INFO",e,...t))}debug(e,...t){this.shouldLog(o.DEBUG)&&console.log(...this.formatMessage("DEBUG",e,...t))}perfDebug(e,...t){this.isDevelopment&&this.shouldLog(o.DEBUG)&&console.log(...this.formatMessage("PERF",e,...t))}group(e,t){if(this.shouldLog(o.DEBUG)){console.group(this.formatMessage("GROUP",e)[0]);try{t()}finally{console.groupEnd()}}}child(e){return new l({...this.config,prefix:`${this.config.prefix}[${e}]`})}}const c=new l,g=e=>c.child(e),d=g("ErrorHandler");var h,u;!function(e){e.LOW="low",e.MEDIUM="medium",e.HIGH="high",e.CRITICAL="critical"}(h||(h={})),function(e){e.NETWORK="network",e.SETTINGS="settings",e.CELL_PROCESSING="cell_processing",e.UI="ui",e.DATA_TRANSMISSION="data_transmission",e.INITIALIZATION="initialization"}(u||(u={}));const m=new class{constructor(){this.config={showNotifications:!0,logToConsole:!0,reportToServer:!1}}configure(e){this.config={...this.config,...e}}handle(e){const{error:t,category:s,severity:o,context:i,userMessage:n,shouldNotifyUser:r,metadata:a}=e;this.logError(t,s,o,i,a),r&&this.config.showNotifications&&this.showUserNotification(n||this.getDefaultUserMessage(s,o),o),this.config.reportToServer&&this.reportError(e)}logError(e,t,s,o,i){const n=`[${t.toUpperCase()}] ${o?`${o}: `:""}${e.message}`,r={error:e.stack||e.message,category:t,severity:s,context:o,...i};switch(s){case h.CRITICAL:case h.HIGH:d.error(n,r);break;case h.MEDIUM:d.warn(n,r);break;case h.LOW:d.info(n,r)}}showUserNotification(e,t){const s={autoClose:this.getNotificationAutoClose(t)};switch(t){case h.CRITICAL:case h.HIGH:n.Notification.error(e,s);break;case h.MEDIUM:n.Notification.warning(e,s);break;case h.LOW:n.Notification.info(e,s)}}getNotificationAutoClose(e){switch(e){case h.CRITICAL:return 0;case h.HIGH:return 1e4;case h.MEDIUM:return 5e3;case h.LOW:return 3e3}}getDefaultUserMessage(e,t){const s=t===h.CRITICAL||t===h.HIGH?"重要: ":"";switch(e){case u.NETWORK:return`${s}ネットワーク接続に問題があります。インターネット接続を確認してください。`;case u.SETTINGS:return`${s}設定に問題があります。拡張機能の設定を確認してください。`;case u.CELL_PROCESSING:return`${s}セル処理中にエラーが発生しました。しばらく待ってから再試行してください。`;case u.UI:return`${s}画面表示でエラーが発生しました。画面を再読み込みしてください。`;case u.DATA_TRANSMISSION:return`${s}データ送信でエラーが発生しました。自動的に再試行します。`;case u.INITIALIZATION:return`${s}拡張機能の初期化でエラーが発生しました。JupyterLabを再起動してください。`;default:return`${s}予期しないエラーが発生しました。`}}reportError(e){d.debug("Error reporting to server not yet implemented",{errorInfo:e})}},p=(e,t,s)=>{m.handle({error:e,category:u.NETWORK,severity:h.MEDIUM,context:t,userMessage:s,shouldNotifyUser:!0})},f=(e,t,s)=>{m.handle({error:e,category:u.CELL_PROCESSING,severity:h.LOW,context:t,shouldNotifyUser:!1,metadata:s})},N=(e,t,s)=>{m.handle({error:e,category:u.UI,severity:h.MEDIUM,context:t,userMessage:s,shouldNotifyUser:!0})},v=(e,t,s)=>{m.handle({error:e,category:u.DATA_TRANSMISSION,severity:h.MEDIUM,context:t,shouldNotifyUser:!0,metadata:s})};function y(e){return e?/^チーム([A-Z]|[1-9][0-9]?)$/.test(e)?{isValid:!0}:{isValid:!1,error:"チーム名は「チームA-Z」または「チーム1-99」の形式で入力してください（例: チームA, チーム1, チーム10）"}:{isValid:!1,error:"チーム名は必須です"}}class b{constructor(){this.settings=null,this.logger=g("SettingsManager")}async initialize(e,t){try{this.settings=await e.load(t),this.settings.changed.connect(()=>{this.validateAndUpdateSettings()}),this.setupRealtimeValidation(e,t),this.updateSettingsFromRegistry(),this.logger.info("Settings initialized successfully")}catch(e){(e=>{m.handle({error:e,category:u.SETTINGS,severity:h.HIGH,context:"Settings initialization",userMessage:"設定の初期化に失敗しました。デフォルト設定で継続します。",shouldNotifyUser:!0})})(e instanceof Error?e:new Error(String(e)))}}updateSettingsFromRegistry(){if(this.settings)try{const e=this.settings.get("serverUrl").composite,t=this.settings.get("emailAddress").composite,s=this.settings.get("userName").composite,o=this.settings.get("teamName").composite,i=this.settings.get("retryAttempts").composite,n=this.settings.get("showNotifications").composite;if(o){const e=y(o);e.isValid||this.logger.warn("Invalid team name detected:",e.error)}this.logger.debug("Settings updated from registry",{serverUrl:e||"default",emailAddress:t||"student001@example.com",userName:s||"Anonymous",teamName:o||"チームA",retryAttempts:i,showNotifications:n})}catch(e){this.logger.warn("Failed to update settings from registry:",e)}}getSettings(){return this.settings}getUserInfo(){if(!this.settings)return{emailAddress:"student001@example.com",userName:"Anonymous",teamName:"チームA"};const e=this.settings.get("emailAddress").composite,t=this.settings.get("userName").composite,s=this.settings.get("teamName").composite;let o=s||"チームA";if(s){const e=y(s);e.isValid||(this.logger.warn("Invalid team name, using default:",e.error),o="チームA")}return{emailAddress:e||"student001@example.com",userName:t||"Anonymous",teamName:o}}setupRealtimeValidation(e,t){new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&this.enhanceTeamNameInput()})}).observe(document.body,{childList:!0,subtree:!0})}enhanceTeamNameInput(){document.querySelectorAll('input[data-setting-path*="teamName"]').forEach(e=>{e instanceof HTMLInputElement&&!e.dataset.enhanced&&(e.dataset.enhanced="true",e.addEventListener("input",e=>{const t=e.target,s=t.value;if(s){const e=y(s);e.isValid?(t.style.borderColor="#4caf50",t.style.backgroundColor="#f0f8f0",this.clearValidationMessage(t)):(t.style.borderColor="#f44336",t.style.backgroundColor="#fdf0f0",this.showValidationMessage(t,e.error||""))}else t.style.borderColor="",t.style.backgroundColor="",this.clearValidationMessage(t)}),e.addEventListener("focus",e=>{const t=e.target;this.showHelpMessage(t)}),e.addEventListener("blur",e=>{const t=e.target;this.clearHelpMessage(t)}))})}showValidationMessage(e,t){var s;this.clearValidationMessage(e);const o=document.createElement("div");o.className="team-name-validation-error",o.style.cssText="\n      color: #f44336;\n      font-size: 12px;\n      margin-top: 4px;\n      padding: 4px;\n      background-color: #ffebee;\n      border-radius: 4px;\n      border-left: 3px solid #f44336;\n    ",o.textContent=t,null===(s=e.parentNode)||void 0===s||s.insertBefore(o,e.nextSibling)}clearValidationMessage(e){var t;const s=null===(t=e.parentNode)||void 0===t?void 0:t.querySelector(".team-name-validation-error");s&&s.remove()}showHelpMessage(e){var t;this.clearHelpMessage(e);const s=document.createElement("div");s.className="team-name-help-message",s.style.cssText="\n      color: #1976d2;\n      font-size: 12px;\n      margin-top: 4px;\n      padding: 4px;\n      background-color: #e3f2fd;\n      border-radius: 4px;\n      border-left: 3px solid #1976d2;\n    ",s.innerHTML="\n      <strong>チーム名の形式:</strong><br>\n      • チームA〜Z (例: チームA, チームB)<br>\n      • チーム1〜99 (例: チーム1, チーム10)\n    ",null===(t=e.parentNode)||void 0===t||t.insertBefore(s,e.nextSibling)}clearHelpMessage(e){var t;const s=null===(t=e.parentNode)||void 0===t?void 0:t.querySelector(".team-name-help-message");s&&s.remove()}validateAndUpdateSettings(){this.updateSettingsFromRegistry(),setTimeout(()=>{this.enhanceTeamNameInput()},100)}validateTeamName(e){return y(e)}getServerUrl(){return this.settings&&this.settings.get("serverUrl").composite||"http://localhost:8000/api/v1/events"}getRetryAttempts(){return this.settings&&this.settings.get("retryAttempts").composite||3}getNotificationSettings(){if(!this.settings)return{showNotifications:!0};const e=this.settings.get("showNotifications").composite;return{showNotifications:void 0===e||e}}}function S(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}class x{constructor(e,t,s){this.executionHandlerRegistered=!1,this.helpSession=new Map,this.processedCells=new Map,this.logger=g("EventManager"),this.notebookTracker=e,this.settingsManager=t,this.dataTransmissionService=s,this.sessionId=S()}initialize(){this.setupNotebookTracking(),this.setupExecutionTracking()}setupNotebookTracking(){this.notebookTracker.widgetAdded.connect((e,t)=>{const s=t.context.path||"unknown";this.sendNotebookEvent("notebook_opened",s),this.addHelpButtonToNotebook(t)})}setupExecutionTracking(){this.executionHandlerRegistered||(r.NotebookActions.executed.connect((e,t)=>{const{cell:s}=t;this.processCellExecution(s)}),this.executionHandlerRegistered=!0,this.logger.info("Cell execution handler registered (once)"))}processCellExecution(e){var t,s;try{if(!e||!e.model)return;const s=performance.now(),o=e.model.id,i=Date.now(),n=i-(this.processedCells.get(o)||0);if(this.logger.perfDebug("Cell execution processing",{cellId:o,timeSinceLastProcessing:n,alreadyProcessed:this.processedCells.has(o),memoryUsage:`${this.processedCells.size} / 50 max`}),n<500&&this.processedCells.has(o))return void this.logger.debug("Skipping duplicate cell execution processing",{cellId:o,timeDiff:n});if(this.processedCells.set(o,i),this.processedCells.size>=50){const e=this.processedCells.keys().next().value;e&&(this.processedCells.delete(e),this.logger.debug("Memory cleanup: removed oldest cell entry",{removedKey:e,currentSize:this.processedCells.size}))}let r="";try{e.model.sharedModel&&e.model.sharedModel.source?r=e.model.sharedModel.source:e.model.value&&e.model.value.text?r=e.model.value.text:e.editor&&e.editor.model&&e.editor.model.value&&(r=e.editor.model.value.text)}catch(e){this.logger.warn("Failed to get cell code:",e)}const a=this.notebookTracker.currentWidget;if(!a)return;const l=(null===(t=a.context)||void 0===t?void 0:t.path)||"";let c,g;try{const t=a.content.widgets;for(let e=0;e<t.length;e++)if(t[e].model.id===o){c=e;break}e.model.type&&(g=e.model.type)}catch(e){this.logger.warn("Failed to get cell index or type:",e)}let d,h=!1,u="",m="";if(e.outputArea){try{d=e.model.executionCount||void 0}catch(e){this.logger.warn("Failed to get execution count:",e)}const t=e.outputArea.model.toJSON();for(const e of t){if("error"===e.output_type){h=!0,m=`${e.ename}: ${e.evalue}`,u=m;break}"execute_result"!==e.output_type&&"display_data"!==e.output_type||e.data&&e.data["text/plain"]&&(u=e.data["text/plain"])}}const p=performance.now(),f=Math.round(p-s),{emailAddress:N,userName:v,teamName:y}=this.settingsManager.getUserInfo(),b={eventId:S(),eventType:"cell_executed",eventTime:(new Date).toISOString(),emailAddress:N,teamName:y,userName:v,sessionId:this.sessionId,notebookPath:l,cellId:o,cellIndex:c,cellType:g,code:r,executionCount:d,hasError:h,errorMessage:h?m:void 0,result:u,executionDurationMs:f};this.dataTransmissionService.sendProgressData([b])}catch(t){f(t instanceof Error?t:new Error(String(t)),"Cell execution processing",{cellId:null===(s=null==e?void 0:e.model)||void 0===s?void 0:s.id})}}async sendNotebookEvent(e,t){try{const{emailAddress:s,userName:o,teamName:i}=this.settingsManager.getUserInfo(),n={eventId:S(),eventType:e,eventTime:(new Date).toISOString(),emailAddress:s,teamName:i,userName:o,sessionId:this.sessionId,notebookPath:t};await this.dataTransmissionService.sendProgressData([n])}catch(s){f(s instanceof Error?s:new Error(String(s)),"Notebook event transmission",{eventType:e,notebookPath:t})}}async startHelpSession(){try{const e=this.notebookTracker.currentWidget;if(!e)return void n.Notification.warning("ノートブックが開かれていません");const t=e.context.path||"unknown",{emailAddress:s,userName:o,teamName:i}=this.settingsManager.getUserInfo();this.helpSession.set(t,!0);const r={eventId:S(),eventType:"help",eventTime:(new Date).toISOString(),emailAddress:s,teamName:i,userName:o,sessionId:this.sessionId,notebookPath:t};await this.dataTransmissionService.sendProgressData([r]);const{showNotifications:a}=this.settingsManager.getNotificationSettings();a&&n.Notification.info("ヘルプセッションを開始しました",{autoClose:2e3})}catch(e){N(e instanceof Error?e:new Error(String(e)),"Help session start","ヘルプセッションの開始に失敗しました。")}}async stopHelpSession(){try{const e=this.notebookTracker.currentWidget;if(!e)return;const t=e.context.path||"unknown";if(!this.helpSession.get(t))return;const{emailAddress:s,userName:o,teamName:i}=this.settingsManager.getUserInfo();this.helpSession.set(t,!1);const r={eventId:S(),eventType:"help_stop",eventTime:(new Date).toISOString(),emailAddress:s,teamName:i,userName:o,sessionId:this.sessionId,notebookPath:t};await this.dataTransmissionService.sendProgressData([r]);const{showNotifications:a}=this.settingsManager.getNotificationSettings();a&&n.Notification.success("ヘルプセッションを停止しました",{autoClose:2e3})}catch(e){N(e instanceof Error?e:new Error(String(e)),"Help session stop","ヘルプセッションの停止に失敗しました。")}}startNewSession(){this.sessionId=S(),this.helpSession.clear(),this.processedCells.clear(),this.logger.info("New session started:",this.sessionId)}addHelpButtonToNotebook(e){if(e.toolbar)try{const t=e.toolbar.node.querySelector(".jp-help-button");t&&(this.logger.debug("Removing existing help button to prevent duplicates"),t.remove());const s=this.createHelpButton();e.toolbar.addItem("help-button",s),this.logger.info("Help button added to notebook toolbar")}catch(e){N(e instanceof Error?e:new Error(String(e)),"Help button creation","ヘルプボタンの作成に失敗しました。")}}createHelpButton(){this.logger.debug("Creating help button with best practices...");const e=new n.ToolbarButton({className:"jp-help-button jp-ToolbarButton",onClick:()=>{},tooltip:"ヘルプ要請ボタン - クリックでON/OFF切替",label:"講師に助けを求める",iconClass:"",enabled:!0});return this.logger.debug("ToolbarButton created:",e),setTimeout(()=>{e.onClick=()=>{this.logger.debug("Help button clicked!"),this.toggleHelpState(e)},e.node.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.logger.debug("Help button DOM click event triggered"),this.toggleHelpState(e)}),this.logger.debug("Help button click handlers set up")},100),e}toggleHelpState(e){const t=this.notebookTracker.currentWidget;if(!t)return void n.Notification.warning("ノートブックが開かれていません");const s=t.context.path||"unknown",o=this.helpSession.get(s)||!1;this.logger.debug("toggleHelpState called, current state:",o),o?(this.stopHelpSession(),e.node.style.backgroundColor="",e.node.style.color="",e.node.textContent="講師に助けを求める"):(this.startHelpSession(),e.node.style.backgroundColor="#ff6b6b",e.node.style.color="white",e.node.textContent="ヘルプ中...")}}var I=s(801),w=s.n(I);class M{constructor(e){this.logger=g("DataTransmissionService"),this.settingsManager=e}async sendProgressData(e){if(0===e.length)return;const{showNotifications:t}=this.settingsManager.getNotificationSettings();this.logger.debug("Sending progress data",{eventCount:e.length,showNotifications:t,events:e.map(e=>({eventType:e.eventType,eventId:e.eventId}))});const s=this.settingsManager.getServerUrl(),o=this.settingsManager.getRetryAttempts();let i=0;for(;i<=o;)try{await w().post(s,e),this.logger.info("Student progress data sent successfully",{eventCount:e.length}),e.length>0&&t&&n.Notification.info(`Learning data sent (${e.length} events)`,{autoClose:3e3});break}catch(t){const s=t instanceof Error?t:new Error(String(t));if(i>=o){v(s,"Progress data transmission - max retries exceeded",{eventCount:e.length,retryAttempt:i});break}p(s,`Progress data transmission - retry ${i}/${o}`,void 0),await new Promise(e=>setTimeout(e,1e3*Math.pow(2,i-1))),i++}}async sendLegacyData(e){if(0===e.length)return;const t=this.settingsManager.getServerUrl().replace("student-progress","cell-monitor"),s=this.settingsManager.getRetryAttempts();let o=0;for(;o<=s;)try{await w().post(t,e),this.logger.info("Legacy cell execution data sent successfully",{itemCount:e.length});break}catch(t){const i=t instanceof Error?t:new Error(String(t));if(o>=s){v(i,"Legacy data transmission - max retries exceeded",{itemCount:e.length,retryAttempt:o});break}p(i,`Legacy data transmission - retry ${o}/${s}`),o++,await new Promise(e=>setTimeout(e,1e3*Math.pow(2,o-1)))}}}const T="cell-monitor:plugin";class C{constructor(e,t,s,o){this.logger=g("CellMonitorPlugin"),this.app=e,this.settingsManager=new b,this.dataTransmissionService=new M(this.settingsManager),this.eventManager=new x(t,this.settingsManager,this.dataTransmissionService),this.initialize(s,o)}async initialize(e,t){try{this.logger.info("Initializing Cell Monitor extension..."),await this.settingsManager.initialize(e,T),this.setupSettingsValidation();const{showNotifications:s}=this.settingsManager.getNotificationSettings();m.configure({showNotifications:s}),this.eventManager.initialize(),this.setupToolbarButtons(t),s&&n.Notification.success("Cell Monitor Extension Activated",{autoClose:2e3}),this.logger.info("Cell Monitor extension activated successfully")}catch(e){throw(e=>{m.handle({error:e,category:u.INITIALIZATION,severity:h.CRITICAL,context:"Plugin initialization",shouldNotifyUser:!0})})(e instanceof Error?e:new Error(String(e))),e}}setupToolbarButtons(e){const t=new n.ToolbarButton({label:"新セッション",tooltip:"新しい学習セッションを開始します",onClick:()=>this.startNewSession(),className:"jp-new-session-button"});this.app.shell.add(t,"top",{rank:1001}),this.logger.debug("New session button added to toolbar")}setupSettingsValidation(){const e=this.settingsManager.getSettings();e&&e.changed.connect(()=>{const e=this.settingsManager.getUserInfo(),t=this.settingsManager.validateTeamName(e.teamName);t.isValid||(n.Notification.error(`チーム名設定エラー: ${t.error}`,{autoClose:5e3}),this.logger.error("Team name validation failed:",t.error))})}startNewSession(){this.logger.info("Starting new learning session");const e=this.settingsManager.getUserInfo(),t=this.settingsManager.validateTeamName(e.teamName);if(!t.isValid)return void n.Notification.error(`セッション開始失敗: ${t.error}`,{autoClose:5e3});this.eventManager.startNewSession();const{showNotifications:s}=this.settingsManager.getNotificationSettings();s&&n.Notification.success(`新しい学習セッションを開始しました (${e.teamName})`,{autoClose:2e3})}}const E={id:T,description:"JupyterLab extension for cell execution monitoring",autoStart:!0,requires:[r.INotebookTracker,a.ISettingRegistry,i.ILabShell],activate:async(e,t,s,o)=>{new C(e,t,s,o)}}}}]);