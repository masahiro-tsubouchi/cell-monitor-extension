"use strict";(self.webpackChunkcell_monitor=self.webpackChunkcell_monitor||[]).push([[814],{814:(e,t,s)=>{s.r(t),s.d(t,{default:()=>E});var o,i=s(586),n=s(715),r=s(531),a=s(361);!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"}(o||(o={}));class l{constructor(e={}){this.isDevelopment=this.detectDevelopmentMode(),this.config={level:this.isDevelopment?o.DEBUG:o.ERROR,prefix:"[CellMonitor]",enabledInProduction:!1,...e}}detectDevelopmentMode(){try{return"undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||null!==document.querySelector("[data-jupyter-widgets-version]"))}catch(e){return!1}}shouldLog(e){return this.isDevelopment||this.config.enabledInProduction?e<=this.config.level:e===o.ERROR}formatMessage(e,t,...s){const o=(new Date).toISOString().split("T")[1].split(".")[0];return[`${this.config.prefix}[${e}][${o}]`,t,...s]}error(e,...t){this.shouldLog(o.ERROR)&&console.error(...this.formatMessage("ERROR",e,...t))}warn(e,...t){this.shouldLog(o.WARN)&&console.warn(...this.formatMessage("WARN",e,...t))}info(e,...t){this.shouldLog(o.INFO)&&console.info(...this.formatMessage("INFO",e,...t))}debug(e,...t){this.shouldLog(o.DEBUG)&&console.log(...this.formatMessage("DEBUG",e,...t))}perfDebug(e,...t){this.isDevelopment&&this.shouldLog(o.DEBUG)&&console.log(...this.formatMessage("PERF",e,...t))}group(e,t){if(this.shouldLog(o.DEBUG)){console.group(this.formatMessage("GROUP",e)[0]);try{t()}finally{console.groupEnd()}}}child(e){return new l({...this.config,prefix:`${this.config.prefix}[${e}]`})}}const c=new l,g=e=>c.child(e),d=g("ErrorHandler");var h,u;!function(e){e.LOW="low",e.MEDIUM="medium",e.HIGH="high",e.CRITICAL="critical"}(h||(h={})),function(e){e.NETWORK="network",e.SETTINGS="settings",e.CELL_PROCESSING="cell_processing",e.UI="ui",e.DATA_TRANSMISSION="data_transmission",e.INITIALIZATION="initialization"}(u||(u={}));const p=new class{constructor(){this.config={showNotifications:!0,logToConsole:!0,reportToServer:!1}}configure(e){this.config={...this.config,...e}}handle(e){const{error:t,category:s,severity:o,context:i,userMessage:n,shouldNotifyUser:r,metadata:a}=e;this.logError(t,s,o,i,a),r&&this.config.showNotifications&&this.showUserNotification(n||this.getDefaultUserMessage(s,o),o),this.config.reportToServer&&this.reportError(e)}logError(e,t,s,o,i){const n=`[${t.toUpperCase()}] ${o?`${o}: `:""}${e.message}`,r={error:e.stack||e.message,category:t,severity:s,context:o,...i};switch(s){case h.CRITICAL:case h.HIGH:d.error(n,r);break;case h.MEDIUM:d.warn(n,r);break;case h.LOW:d.info(n,r)}}showUserNotification(e,t){const s={autoClose:this.getNotificationAutoClose(t)};switch(t){case h.CRITICAL:case h.HIGH:n.Notification.error(e,s);break;case h.MEDIUM:n.Notification.warning(e,s);break;case h.LOW:n.Notification.info(e,s)}}getNotificationAutoClose(e){switch(e){case h.CRITICAL:return 0;case h.HIGH:return 1e4;case h.MEDIUM:return 5e3;case h.LOW:return 3e3}}getDefaultUserMessage(e,t){const s=t===h.CRITICAL||t===h.HIGH?"重要: ":"";switch(e){case u.NETWORK:return`${s}ネットワーク接続に問題があります。インターネット接続を確認してください。`;case u.SETTINGS:return`${s}設定に問題があります。拡張機能の設定を確認してください。`;case u.CELL_PROCESSING:return`${s}セル処理中にエラーが発生しました。しばらく待ってから再試行してください。`;case u.UI:return`${s}画面表示でエラーが発生しました。画面を再読み込みしてください。`;case u.DATA_TRANSMISSION:return`${s}データ送信でエラーが発生しました。自動的に再試行します。`;case u.INITIALIZATION:return`${s}拡張機能の初期化でエラーが発生しました。JupyterLabを再起動してください。`;default:return`${s}予期しないエラーが発生しました。`}}reportError(e){d.debug("Error reporting to server not yet implemented",{errorInfo:e})}},m=(e,t,s)=>{p.handle({error:e,category:u.NETWORK,severity:h.MEDIUM,context:t,userMessage:s,shouldNotifyUser:!0})},f=(e,t,s)=>{p.handle({error:e,category:u.CELL_PROCESSING,severity:h.LOW,context:t,shouldNotifyUser:!1,metadata:s})},v=(e,t,s)=>{p.handle({error:e,category:u.DATA_TRANSMISSION,severity:h.MEDIUM,context:t,shouldNotifyUser:!0,metadata:s})};function b(e){return e?/^チーム([A-Z]|[1-9][0-9]?)$/.test(e)?{isValid:!0}:{isValid:!1,error:"チーム名は「チームA-Z」または「チーム1-99」の形式で入力してください（例: チームA, チーム1, チーム10）"}:{isValid:!1,error:"チーム名は必須です"}}class S{constructor(){this.settings=null,this.logger=g("SettingsManager")}async initialize(e,t){try{this.settings=await e.load(t),this.settings.changed.connect(()=>{this.validateAndUpdateSettings()}),this.setupRealtimeValidation(e,t),this.updateSettingsFromRegistry(),this.logger.info("Settings initialized successfully")}catch(e){(e=>{p.handle({error:e,category:u.SETTINGS,severity:h.HIGH,context:"Settings initialization",userMessage:"設定の初期化に失敗しました。デフォルト設定で継続します。",shouldNotifyUser:!0})})(e instanceof Error?e:new Error(String(e)))}}updateSettingsFromRegistry(){if(this.settings)try{const e=this.settings.get("serverUrl").composite,t=this.settings.get("emailAddress").composite,s=this.settings.get("userName").composite,o=this.settings.get("teamName").composite,i=this.settings.get("retryAttempts").composite,n=this.settings.get("showNotifications").composite;if(o){const e=b(o);e.isValid||this.logger.warn("Invalid team name detected:",e.error)}this.logger.debug("Settings updated from registry",{serverUrl:e||"default",emailAddress:t||"student001@example.com",userName:s||"Anonymous",teamName:o||"チームA",retryAttempts:i,showNotifications:n})}catch(e){this.logger.warn("Failed to update settings from registry:",e)}}getSettings(){return this.settings}getUserInfo(){if(!this.settings)return{emailAddress:"student001@example.com",userName:"Anonymous",teamName:"チームA"};const e=this.settings.get("emailAddress").composite,t=this.settings.get("userName").composite,s=this.settings.get("teamName").composite;let o=s||"チームA";if(s){const e=b(s);e.isValid||(this.logger.warn("Invalid team name, using default:",e.error),o="チームA")}return{emailAddress:e||"student001@example.com",userName:t||"Anonymous",teamName:o}}setupRealtimeValidation(e,t){new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&this.enhanceTeamNameInput()})}).observe(document.body,{childList:!0,subtree:!0})}enhanceTeamNameInput(){document.querySelectorAll('input[data-setting-path*="teamName"]').forEach(e=>{e instanceof HTMLInputElement&&!e.dataset.enhanced&&(e.dataset.enhanced="true",e.addEventListener("input",e=>{const t=e.target,s=t.value;if(s){const e=b(s);e.isValid?(t.style.borderColor="#4caf50",t.style.backgroundColor="#f0f8f0",this.clearValidationMessage(t)):(t.style.borderColor="#f44336",t.style.backgroundColor="#fdf0f0",this.showValidationMessage(t,e.error||""))}else t.style.borderColor="",t.style.backgroundColor="",this.clearValidationMessage(t)}),e.addEventListener("focus",e=>{const t=e.target;this.showHelpMessage(t)}),e.addEventListener("blur",e=>{const t=e.target;this.clearHelpMessage(t)}))})}showValidationMessage(e,t){var s;this.clearValidationMessage(e);const o=document.createElement("div");o.className="team-name-validation-error",o.style.cssText="\n      color: #f44336;\n      font-size: 12px;\n      margin-top: 4px;\n      padding: 4px;\n      background-color: #ffebee;\n      border-radius: 4px;\n      border-left: 3px solid #f44336;\n    ",o.textContent=t,null===(s=e.parentNode)||void 0===s||s.insertBefore(o,e.nextSibling)}clearValidationMessage(e){var t;const s=null===(t=e.parentNode)||void 0===t?void 0:t.querySelector(".team-name-validation-error");s&&s.remove()}showHelpMessage(e){var t;this.clearHelpMessage(e);const s=document.createElement("div");s.className="team-name-help-message",s.style.cssText="\n      color: #1976d2;\n      font-size: 12px;\n      margin-top: 4px;\n      padding: 4px;\n      background-color: #e3f2fd;\n      border-radius: 4px;\n      border-left: 3px solid #1976d2;\n    ",s.innerHTML="\n      <strong>チーム名の形式:</strong><br>\n      • チームA〜Z (例: チームA, チームB)<br>\n      • チーム1〜99 (例: チーム1, チーム10)\n    ",null===(t=e.parentNode)||void 0===t||t.insertBefore(s,e.nextSibling)}clearHelpMessage(e){var t;const s=null===(t=e.parentNode)||void 0===t?void 0:t.querySelector(".team-name-help-message");s&&s.remove()}validateAndUpdateSettings(){this.updateSettingsFromRegistry(),setTimeout(()=>{this.enhanceTeamNameInput()},100)}validateTeamName(e){return b(e)}getServerUrl(){return this.settings&&this.settings.get("serverUrl").composite||"http://localhost:8000/api/v1/events"}getRetryAttempts(){return this.settings&&this.settings.get("retryAttempts").composite||3}getNotificationSettings(){var e;if(!this.settings)return{showNotifications:!0,animationEnabled:!0};const t=this.settings.get("showNotifications").composite,s=null===(e=this.settings.get("animationEnabled"))||void 0===e?void 0:e.composite;return{showNotifications:void 0===t||t,animationEnabled:void 0===s||s}}}function I(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}class y{constructor(e,t,s){this.executionHandlerRegistered=!1,this.helpSession=new Map,this.helpIntervals=new Map,this.helpSessionTimestamps=new Map,this.processedCells=new Map,this.logger=g("EventManager"),this.notebookTracker=e,this.settingsManager=t,this.dataTransmissionService=s,this.sessionId=I()}initialize(){this.setupNotebookTracking(),this.setupExecutionTracking()}setupNotebookTracking(){this.notebookTracker.widgetAdded.connect((e,t)=>{const s=t.context.path||"unknown";this.sendNotebookEvent("notebook_opened",s),this.addHelpButtonToNotebook(t)})}setupExecutionTracking(){this.executionHandlerRegistered||(r.NotebookActions.executed.connect((e,t)=>{const{cell:s}=t;this.processCellExecution(s)}),this.executionHandlerRegistered=!0,this.logger.info("Cell execution handler registered (once)"))}processCellExecution(e){var t,s;try{if(!e||!e.model)return;const s=performance.now(),o=e.model.id,i=Date.now(),n=this.processedCells.get(o)||0,r=i-n,a=Math.max(0,Math.min(r,3e5));if(r>3e5&&this.logger.warn("Abnormal timestamp detected",{currentTime:i,lastTime:n,rawDiff:r}),this.logger.perfDebug("Cell execution processing",{cellId:o,timeSinceLastProcessing:a,alreadyProcessed:this.processedCells.has(o),memoryUsage:`${this.processedCells.size} / 50 max`}),a<500&&this.processedCells.has(o))return void this.logger.debug("Skipping duplicate cell execution processing",{cellId:o,timeDiff:a});if(this.processedCells.set(o,i),this.processedCells.size>=50){const e=this.processedCells.keys().next().value;e&&(this.processedCells.delete(e),this.logger.debug("Memory cleanup: removed oldest cell entry",{removedKey:e,currentSize:this.processedCells.size}))}let l="";try{e.model.sharedModel&&e.model.sharedModel.source?l=e.model.sharedModel.source:e.model.value&&e.model.value.text?l=e.model.value.text:e.editor&&e.editor.model&&e.editor.model.value&&(l=e.editor.model.value.text)}catch(e){this.logger.warn("Failed to get cell code:",e)}const c=this.notebookTracker.currentWidget;if(!c)return;const g=(null===(t=c.context)||void 0===t?void 0:t.path)||"";let d,h;try{const t=c.content.widgets;for(let e=0;e<t.length;e++)if(t[e].model.id===o){d=e;break}e.model.type&&(h=e.model.type)}catch(e){this.logger.warn("Failed to get cell index or type:",e)}let u,p=!1,m="",f="";if(e.outputArea){try{u=e.model.executionCount||void 0}catch(e){this.logger.warn("Failed to get execution count:",e)}const t=e.outputArea.model.toJSON();for(const e of t){if("error"===e.output_type){p=!0,f=`${e.ename}: ${e.evalue}`,m=f;break}"execute_result"!==e.output_type&&"display_data"!==e.output_type||e.data&&e.data["text/plain"]&&(m=e.data["text/plain"])}}const v=performance.now(),b=Math.round(v-s),{emailAddress:S,userName:y,teamName:N}=this.settingsManager.getUserInfo(),w={eventId:I(),eventType:"cell_executed",eventTime:(new Date).toISOString(),emailAddress:S,teamName:N,userName:y,sessionId:this.sessionId,notebookPath:g,cellId:o,cellIndex:d,cellType:h,code:l,executionCount:u,hasError:p,errorMessage:p?f:void 0,result:m,executionDurationMs:b};this.dataTransmissionService.sendProgressData([w])}catch(t){f(t instanceof Error?t:new Error(String(t)),"Cell execution processing",{cellId:null===(s=null==e?void 0:e.model)||void 0===s?void 0:s.id})}}async sendNotebookEvent(e,t){try{const{emailAddress:s,userName:o,teamName:i}=this.settingsManager.getUserInfo(),n={eventId:I(),eventType:e,eventTime:(new Date).toISOString(),emailAddress:s,teamName:i,userName:o,sessionId:this.sessionId,notebookPath:t};await this.dataTransmissionService.sendProgressData([n])}catch(s){f(s instanceof Error?s:new Error(String(s)),"Notebook event transmission",{eventType:e,notebookPath:t})}}startHelpSession(){const e=this.notebookTracker.currentWidget;if(!e)return void this.logger.warn("No notebook widget available for help session start");const t=e.context.path||"unknown";if(this.helpIntervals.has(t))return void this.logger.debug("Help session already active",{notebookPath:t.substring(0,20)+"..."});this.sendHelpEvent(t);const s=setInterval(()=>{this.sendHelpEvent(t)},1e4);this.helpIntervals.set(t,s),this.helpSession.set(t,!0),this.helpSessionTimestamps.set(t,Date.now()),this.logger.info("Continuous help session started",{notebookPath:t.substring(0,20)+"...",intervalId:"set"});const{showNotifications:o}=this.settingsManager.getNotificationSettings();o&&n.Notification.info("継続ヘルプセッションを開始しました",{autoClose:2e3})}stopHelpSession(){const e=this.notebookTracker.currentWidget;if(!e)return void this.logger.warn("No notebook widget available for help session stop");const t=e.context.path||"unknown",s=this.helpIntervals.get(t);s&&(clearInterval(s),this.helpIntervals.delete(t),this.logger.debug("Continuous help sending stopped",{notebookPath:t.substring(0,20)+"..."})),this.sendHelpStopEvent(t),this.bulkCleanupOldSessions(),this.helpSession.set(t,!1);const{showNotifications:o}=this.settingsManager.getNotificationSettings();o&&n.Notification.success("ヘルプセッション停止（メモリクリーンアップ実行）",{autoClose:2e3}),this.logger.info("Help session stopped with bulk cleanup",{notebookPath:t.substring(0,20)+"...",remainingSessions:this.helpSession.size})}addHelpButtonToNotebook(e){if(e.toolbar)try{const t=e.toolbar.node.querySelector(".jp-help-button");t&&(this.logger.debug("Removing existing help button to prevent duplicates"),t.remove());const s=this.createHelpButton();e.toolbar.addItem("help-button",s),this.logger.info("Help button added to notebook toolbar")}catch(e){(e=>{p.handle({error:e,category:u.UI,severity:h.MEDIUM,context:"Help button creation",userMessage:"ヘルプボタンの作成に失敗しました。",shouldNotifyUser:!0})})(e instanceof Error?e:new Error(String(e)))}}createHelpButton(){this.logger.debug("Creating help button with DOM-safe implementation...");const e=new n.ToolbarButton({className:"jp-help-button jp-ToolbarButton",onClick:()=>{this.logger.debug("Help button clicked!"),this.toggleHelpState(e)},tooltip:"ヘルプ要請ボタン - クリックでON/OFF切替",label:"🆘 講師に助けを求める",iconClass:"jp-help-button__icon",enabled:!0});return this.logger.debug("ToolbarButton created with persistent onClick handler"),e}toggleHelpState(e){if(!this.notebookTracker.currentWidget)return void n.Notification.warning("ノートブックが開かれていません");const t=e.node.classList.contains("jp-help-button--active");this.logger.debug("toggleHelpState called, currently active:",t),t?(this.deactivateHelpButton(e),this.stopHelpSession()):(this.activateHelpButton(e),this.startHelpSession())}activateHelpButton(e){e.node.classList.add("jp-help-button--active");const t=e.node.querySelector(".jp-ToolbarButtonComponent-label");t&&(t.textContent="🆘 ヘルプ要請中..."),e.node.setAttribute("title","ヘルプ要請中 - クリックで停止");const s=this.notebookTracker.currentWidget;if(s){const e=s.context.path||"unknown";this.helpSession.set(e,!0)}this.logger.debug("Help button activated with DOM-safe method")}deactivateHelpButton(e){e.node.classList.remove("jp-help-button--active");const t=e.node.querySelector(".jp-ToolbarButtonComponent-label");t&&(t.textContent="🆘 講師に助けを求める"),e.node.setAttribute("title","ヘルプ要請ボタン - クリックでON/OFF切替");const s=this.notebookTracker.currentWidget;if(s){const e=s.context.path||"unknown";this.helpSession.set(e,!1)}this.logger.debug("Help button deactivated with DOM-safe method")}sendHelpEvent(e){const{emailAddress:t,userName:s,teamName:o}=this.settingsManager.getUserInfo(),i={eventId:I(),eventType:"help",eventTime:(new Date).toISOString(),emailAddress:t,teamName:o,userName:s,sessionId:this.sessionId,notebookPath:e};this.dataTransmissionService.sendProgressData([i]).then(()=>{this.logger.debug("Continuous help event sent",{notebookPath:e.substring(0,20)+"..."})}).catch(e=>{this.logger.error("Failed to send continuous help event:",e)})}sendHelpStopEvent(e){const{emailAddress:t,userName:s,teamName:o}=this.settingsManager.getUserInfo(),i={eventId:I(),eventType:"help_stop",eventTime:(new Date).toISOString(),emailAddress:t,teamName:o,userName:s,sessionId:this.sessionId,notebookPath:e};this.dataTransmissionService.sendProgressData([i]).then(()=>{this.logger.debug("Help stop event sent",{notebookPath:e.substring(0,20)+"..."})}).catch(e=>{this.logger.error("Failed to send help stop event:",e)})}bulkCleanupOldSessions(){const e=Date.now()-18e5;let t=0;this.logger.debug("Starting bulk cleanup",{totalSessions:this.helpSession.size,cutoffTime:new Date(e).toISOString()});for(const[s,o]of this.helpSessionTimestamps.entries())if(o<e){this.helpSession.delete(s),this.helpSessionTimestamps.delete(s);const e=this.helpIntervals.get(s);e&&(clearInterval(e),this.helpIntervals.delete(s)),t++}this.emergencyFIFOCleanup(),this.logger.info("Bulk cleanup completed",{removedSessions:t,remainingSessions:this.helpSession.size,memoryReduction:.4*t+"MB estimated"})}emergencyFIFOCleanup(){if(this.helpSession.size>=y.MAX_HELP_SESSIONS){const e=this.helpSession.keys().next().value;if(e){this.helpSession.delete(e),this.helpSessionTimestamps.delete(e);const t=this.helpIntervals.get(e);t&&(clearInterval(t),this.helpIntervals.delete(e)),this.logger.debug("Emergency FIFO cleanup executed",{removedKey:e.substring(0,10)+"***",currentSize:this.helpSession.size})}}}startNewSession(){for(const[,e]of this.helpIntervals.entries())clearInterval(e);this.helpIntervals.clear(),this.sessionId=I(),this.helpSession.clear(),this.helpSessionTimestamps.clear(),this.processedCells.clear(),this.logger.info("New session started with full cleanup:",{sessionId:this.sessionId,memoryCleanup:"complete"})}}y.MAX_HELP_SESSIONS=20;var N=s(801),w=s.n(N);class x{constructor(e){this.logger=g("LoadDistributionService")}async sendWithLoadDistribution(e,t){var s,o;if(0===e.length)return;const i=(null===(s=e[0])||void 0===s?void 0:s.emailAddress)||"",n=(null===(o=e[0])||void 0===o?void 0:o.cellId)||"",r=Date.now(),a=`${i}-${n}-${Math.floor(r/1e3)}`,l=this.hashString(a)%2e3+200;this.logger.debug("Load distribution delay calculated",{userEmail:i.substring(0,5)+"***",delay:l,eventCount:e.length}),await new Promise(e=>setTimeout(e,l)),await t(e)}hashString(e){if(!e)return 0;let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t&=t;return Math.abs(t)}}class M{constructor(e){this.logger=g("DataTransmissionService"),this.connectionPoolCleanupInterval=null,this.pendingRequests=new Map,this.settingsManager=e,this.loadDistributionService=new x(e),this.axiosInstance=w().create({timeout:8e3,headers:{"Content-Type":"application/json"},maxRedirects:3,validateStatus:e=>e<500}),this.legacyAxiosInstance=w().create({timeout:8e3,headers:{"Content-Type":"application/json"},maxRedirects:3,validateStatus:e=>e<500}),this.setupConnectionPoolCleanup()}setupConnectionPoolCleanup(){this.connectionPoolCleanupInterval=setInterval(()=>{this.logger.debug("HTTP connection pool status check - automatic cleanup by browser")},3e4)}dispose(){this.connectionPoolCleanupInterval&&(clearInterval(this.connectionPoolCleanupInterval),this.connectionPoolCleanupInterval=null),this.pendingRequests.clear(),this.logger.debug("DataTransmissionService disposed",{pendingRequestsCleared:!0})}async sendProgressData(e){if(0!==e.length)for(const t of e)await this.sendSingleEventWithDeduplication(t)}async sendSingleEventWithDeduplication(e){var t;const s=Math.floor(Date.now()/6e4),o=`${e.cellId||"unknown"}-${e.eventType}-${s}`;if(this.pendingRequests.has(o))return this.logger.debug("Duplicate request detected, waiting...",{cellId:(null===(t=e.cellId)||void 0===t?void 0:t.substring(0,8))+"...",eventType:e.eventType,requestKey:o.substring(0,20)+"..."}),void await this.pendingRequests.get(o);const i=this.sendSingleEventInternal([e]);this.pendingRequests.set(o,i),i.finally(()=>{this.pendingRequests.delete(o)}),await i}async sendSingleEventInternal(e){let t=!0;try{const e=this.settingsManager.getSettings();if(e&&e.get){const s=e.get("useLoadDistribution");s&&void 0!==s.composite&&(t=s.composite)}}catch(e){this.logger.debug("Failed to get load distribution setting, using default",e)}t?await this.loadDistributionService.sendWithLoadDistribution(e,e=>this.sendProgressDataInternal(e)):await this.sendProgressDataInternal(e)}async sendProgressDataInternal(e){const{showNotifications:t}=this.settingsManager.getNotificationSettings();this.logger.debug("Sending progress data",{eventCount:e.length,showNotifications:t,events:e.map(e=>({eventType:e.eventType,eventId:e.eventId}))});const s=this.settingsManager.getServerUrl(),o=this.settingsManager.getRetryAttempts();let i=0;for(;i<=o;)try{await this.axiosInstance.post(s,e),this.logger.info("Student progress data sent successfully",{eventCount:e.length}),e.length>0&&t&&n.Notification.info(`Learning data sent (${e.length} events)`,{autoClose:3e3});break}catch(t){const s=t instanceof Error?t:new Error(String(t));if(i>=o){v(s,"Progress data transmission - max retries exceeded",{eventCount:e.length,retryAttempt:i});break}m(s,`Progress data transmission - retry ${i}/${o}`,void 0),await new Promise(e=>setTimeout(e,1e3*Math.pow(2,i-1))),i++}}async sendLegacyData(e){if(0===e.length)return;const t=this.settingsManager.getServerUrl().replace("student-progress","cell-monitor"),s=this.settingsManager.getRetryAttempts();let o=0;for(;o<=s;)try{await this.legacyAxiosInstance.post(t,e),this.logger.info("Legacy cell execution data sent successfully",{itemCount:e.length});break}catch(t){const i=t instanceof Error?t:new Error(String(t));if(o>=s){v(i,"Legacy data transmission - max retries exceeded",{itemCount:e.length,retryAttempt:o});break}m(i,`Legacy data transmission - retry ${o}/${s}`),o++,await new Promise(e=>setTimeout(e,1e3*Math.pow(2,o-1)))}}}const T="cell-monitor:plugin";class C{constructor(e,t,s,o){this.logger=g("CellMonitorPlugin"),this.app=e,this.settingsManager=new S,this.dataTransmissionService=new M(this.settingsManager),this.eventManager=new y(t,this.settingsManager,this.dataTransmissionService),this.initialize(s,o)}async initialize(e,t){try{this.logger.info("Initializing Cell Monitor extension..."),await this.settingsManager.initialize(e,T),this.setupSettingsValidation();const{showNotifications:s}=this.settingsManager.getNotificationSettings();p.configure({showNotifications:s}),this.eventManager.initialize(),this.setupToolbarButtons(t),s&&n.Notification.success("Cell Monitor Extension Activated",{autoClose:2e3}),this.logger.info("Cell Monitor extension activated successfully")}catch(e){throw(e=>{p.handle({error:e,category:u.INITIALIZATION,severity:h.CRITICAL,context:"Plugin initialization",shouldNotifyUser:!0})})(e instanceof Error?e:new Error(String(e))),e}}setupToolbarButtons(e){const t=new n.ToolbarButton({label:"新セッション",tooltip:"新しい学習セッションを開始します",onClick:()=>this.startNewSession(),className:"jp-new-session-button"});this.app.shell.add(t,"top",{rank:1001}),this.logger.debug("New session button added to toolbar")}setupSettingsValidation(){const e=this.settingsManager.getSettings();e&&e.changed.connect(()=>{const e=this.settingsManager.getUserInfo(),t=this.settingsManager.validateTeamName(e.teamName);t.isValid||(n.Notification.error(`チーム名設定エラー: ${t.error}`,{autoClose:5e3}),this.logger.error("Team name validation failed:",t.error))})}startNewSession(){this.logger.info("Starting new learning session");const e=this.settingsManager.getUserInfo(),t=this.settingsManager.validateTeamName(e.teamName);if(!t.isValid)return void n.Notification.error(`セッション開始失敗: ${t.error}`,{autoClose:5e3});this.eventManager.startNewSession();const{showNotifications:s}=this.settingsManager.getNotificationSettings();s&&n.Notification.success(`新しい学習セッションを開始しました (${e.teamName})`,{autoClose:2e3})}}const E={id:T,description:"JupyterLab extension for cell execution monitoring",autoStart:!0,requires:[r.INotebookTracker,a.ISettingRegistry,i.ILabShell],activate:async(e,t,s,o)=>{new C(e,t,s,o)}}}}]);