---
trigger: always_on
description: jupyterlab-extension
---

# Project "Cell Monitor": AI-Driven Development Rules

> **適用プロジェクト**: JupyterLab Cell Monitor Extension
> **最終更新日**: 2025-01-19
> **目的**: 本プロジェクトにおけるAI駆動開発の品質、効率、一貫性を確保するための実践的ルールを定める。

## 1. 🎯 AI協調開発の基本ワークフロー

### 1.1. 指示は「具体的」かつ「コンテキストを付与」する

AIへの指示は、常に以下の要素を含めること。

- **目的 (What/Why)**: 何を、なぜ実装するのか。
- **対象ファイル (Where)**: `fastapi_server/api/endpoints/events.py` のように具体的に指定。
- **実装要件 (How)**: 期待する動作、使用するライブラリ、データ構造など。
- **参考情報 (Context)**: 関連する仕様書 (`docs/architecture/API_DATA_SPEC.md`など) や既存コード。

**⭕️ 良い指示の例 (新しいAPIエンドポイント追加)**:
```
"""
【目的】
学生の課題提出状況を管理する新しいAPIエンドポイントを追加する。

【対象ファイル】
`fastapi_server/api/endpoints/submissions.py` (新規作成)

【実装要件】
- `/api/v1/submissions` というエンドポイントを作成。
- `POST`メソッドで、`student_id`, `assignment_id`, `notebook_content` を受け取る。
- データは `db/models.py` の `Submission` モデルを利用してPostgreSQLに保存する。
- 成功時は `submission_id` を返す。

【参考情報】
- データスキーマは `schemas/submission.py` を新規作成して定義。
- 既存の `events.py` の実装スタイルに合わせること。
"""
```

### 1.2. ワークフロー: 「TDD → 実装 → レビュー → ドキュメント」

1.  **テスト先行 (Test First)**: AIに `pytest` のテストコードを先に生成させる。
2.  **実装 (Implement)**: 生成したテストが通るように、AIに本体のコードを実装させる。
3.  **レビュー (Review)**: 人間がコードの品質、セキュリティ、パフォーマンスをレビューする。
4.  **ドキュメント同期 (Document)**: AIに `FASTAPI_SERVER_SPEC.md` などの関連ドキュメントの更新を指示する。

## 2. 🧪 テスト戦略: 品質はテストが担保する

### 2.1. テスト種別と担当範囲

- **単体テスト (`tests/unit`)**: 個々の関数・クラスの動作検証。AIでの生成を基本とする。
- **統合テスト (`tests/integration`)**: 複数コンポーネント連携の検証 (APIとDBなど)。AIで雛形を生成し、人間が調整。
- **E2Eテスト (`tests/e2e`)**: ユーザー操作シナリオ全体の検証。`Playwright` を使用。テストシナリオは人間が設計し、コード生成はAIが支援。

### 2.2. テスト実行ルール

- **開発中**: `pytest tests/unit` をローカルで随時実行。
- **PR作成前**: `pytest` で単体・統合テストをすべて実行し、成功を確認。
- **CI/CD**: プルリクエスト時にGitHub Actions (`.github/workflows/e2e-test.yml`) で全テストが自動実行される。マージには全テストの成功が必須。

**⭕️ テスト生成の指示例**:
```
"""
【目的】
`fastapi_server/worker/event_router.py` の `handle_cell_execution` 関数の単体テストを作成する。

【対象ファイル】
`tests/unit/worker/test_event_router.py`

【テストケース】
1. 正常系: 有効なイベントデータが正しく処理されること。
2. 異常系: InfluxDBへの書き込み失敗時にエラーがログ記録されること。
3. 境界値: `execution_count` が非常に大きい場合の処理。

【使用ツール】
`pytest`, `pytest-asyncio`, `unittest.mock` を使用すること。
"""
```

### 2.3. テスト実行環境

- **Docker内での実行**: 開発環境との一貫性を保証するため、単体・統合・E2EテストはすべてDockerコンテナ内で実行することを原則とします。
- **CI/CD連携**: CI/CDパイプラインでも同様に、Docker環境でテストを実行します。

### 2.4. AI駆動TDD（テスト駆動開発）のベストプラクティス

**TDDはAI駆動開発において非常に有効**であることが実証されています。本プロジェクトでは23個のテストケースが全て成功し、高品質なCRUD実装が実現されました。

#### 2.4.1. AI駆動TDDの基本サイクル

1. **テストファースト**: AIにテストコードを先に生成させる
2. **実装**: テストが通るようにAIに実装させる
3. **リファクタリング**: 必要に応じてコードを改善
4. **検証**: 全テストが通ることを確認

#### 2.4.2. AIへのテスト生成指示テンプレート

**CRUD操作の標準テストパターン**:
```
"""
【目的】
`{モデル名}` モデルの完全なCRUD操作テストを作成する。

【対象ファイル】
`tests/crud/test_crud_{model_name}.py`

【テストケース】
- Create: 基本的な作成機能
- Read: ID取得、存在しないIDの処理
- Update: 完全更新、部分更新、存在しないIDの処理
- Delete: 削除機能、存在しないIDの処理

【外部キー制約】
必要な親レコード（Class, Notebook, Student等）をヘルパー関数で事前作成すること。

【使用ツール】
`pytest`, `sqlalchemy`, 該当するCRUDモジュールとスキーマ
"""
```

#### 2.4.3. 外部キー制約のテストデータ管理

**ヘルパー関数パターン**:
```python
def create_test_dependencies(db_session: Session, identifier: str = "TEST01"):
    """
    テスト用の依存データを作成するヘルパー関数
    """
    # 必要な親レコードを順次作成
    class_record = create_class(...)
    notebook_record = create_notebook(...)
    student_record = create_student(...)

    return class_record.id, notebook_record.id, student_record.id
```

#### 2.4.4. AI駆動TDDの具体的メリット

- **要件明確化**: テストを先に書くことで実装すべき機能が明確になる
- **品質保証**: AI生成コードの動作を自動検証
- **リファクタリング安全性**: コード変更時の回帰を自動検出
- **エラーハンドリング体系化**: 境界条件や異常系を漏れなくカバー
- **ドキュメント効果**: テストコードが仕様書として機能

#### 2.4.5. TDD成功の指標

- **テストカバレッジ**: 各CRUD操作で最低7-8個のテストケース
- **成功率**: 全テストケースが継続的にパス
- **保守性**: テストコードの可読性と再利用性
- **実行速度**: Docker環境での高速テスト実行

## 3. 🔒 コード品質とセキュリティ

### 3.1. コミット毎の静的解析で品質を維持する (pre-commitフック)

本プロジェクトでは、コード品質を自動的に維持するため `pre-commit` を導入しています。コミット前に `black`, `flake8`, `mypy`, `bandit` が自動実行され、品質基準を満たさないコードの混入を防ぎます。

**開発開始時の必須設定:**

```bash
# 1. pre-commitをインストール (pip or poetry)
pip install pre-commit

# 2. gitフックをリポジトリにインストール
pre-commit install
```

**運用ルール:**
- `git commit` を実行すると、設定されたフックが自動的に実行されます。
- エラーが検出された場合、コミットは中断されます。修正後、再度ステージングしてコミットしてください。
- すべてのファイルを対象に手動でチェックを実行することも可能です。

#### チェック内容

現在、以下のツールが自動実行されるように設定されています。
- **black**: コードフォーマッター
- **flake8**: リンター
- **mypy**: 型チェッカー
- **bandit**: セキュリティチェッカー

これらのチェックがすべて成功しない限り、コミットは完了しません。

### 3.2. AI生成コードの必須レビュー観点

- **DBクエリ**: SQLインジェクションの危険性がないか (`execute(f"...")` は禁止)。常にSQLAlchemyのORMやパラメータ化クエリを使用する。
- **エラーハンドリング**: `try...except` が適切に配置され、予期せぬエラーでサーバが停止しないか。
- **パフォーマンス**: 大量データ処理でループ内にDBアクセスがないか。非同期処理 (`async/await`) が適切に使われているか。
- **機密情報**: ログやレスポンスにパスワードなどの機密情報が含まれていないか。

## 4. 🔄 開発ワークフローとGitブランチ戦略

### 4.1. ブランチ戦略

- `main`: 本番リリース用。直接コミットは禁止。
- `develop`: 開発のベースとなるブランチ。PRは `develop` に向けて作成する。
- `feature/xxx`: 機能開発用ブランチ。`develop` から分岐する。
- `bugfix/xxx`: バグ修正用ブランチ。

### 4.2. プルリクエスト (PR) のルール

- **Small PR**: PRは単一の関心事に集中し、小さく保つ。
- **説明の具体性**: PRの説明には、このプロジェクト用のテンプレートに従い、変更内容、AIの活用状況、テスト結果を明記する。
- **セルフレビュー**: PR作成者が、提出前に必ずAI生成コードを含めた全コードをレビューする。

**PRテンプレートの必須項目**:
```markdown
## 変更内容
- (例) 学生の進捗状況をリアルタイムで表示するWebSocketエンドポイントを追加。

## AI活用箇所
- (例) `core/connection_manager.py` の基本構造をAIで生成 (約80%)。
- (例) `tests/unit/core/test_connection_manager.py` のテストケースをAIが提案。

## 動作確認
- [x] ローカルでの `docker compose up` による全サービス起動確認。
- [x] `pytest` で全テストがパスすることを確認。
- [x] (必要に応じて) 手動での画面操作確認。

## 関連ドキュメントの更新
- [x] `docs/architecture/FASTAPI_SERVER_SPEC.md` のAPI仕様を更新。
```

## 5. 📝 ドキュメントは「生きている」

- **コードと同期**: コードを変更したら、必ず関連ドキュメントも同じPR内で更新する。
- **AIで効率化**: ドキュメントの更新作業もAIに指示する。

**⭕️ ドキュメント更新の指示例**:
```
"""
【目的】
先ほど追加した `/api/v1/submissions` エンドポイントの仕様をドキュメントに反映する。

【対象ファイル】
`docs/architecture/FASTAPI_SERVER_SPEC.md`

【更新内容】
- APIエンドポイント一覧に `/api/v1/submissions` を追加。
- リクエストボディ、レスポンスのスキーマを追記。
- `curl` を使ったリクエスト例を追加。

【参考情報】
`fastapi_server/api/endpoints/submissions.py` の実装を参照すること。
"""
```


## 6. 📈 プロジェクト計画とタスク管理

本プロジェクトでは、計画の粒度に応じてドキュメントを使い分けるハイブリッド方式を採用します。

- **大局的な計画 (Roadmap)**:
  - **ファイル**: `docs/PROJECT_ROADMAP.md`
  - **内容**: プロジェクト全体の目標、主要なマイルストーン、リリース計画など、長期的な視点での計画を記載します。
  - **更新タイミング**: マイルストーンの達成時や、プロジェクトの方向性に大きな変更があった場合に更新します。

- **短期的な計画とタスク (Plan & Tasks)**:
  - **ファイル**: `plan.md` (ルートディレクトリ)
  - **内容**: 現在進行中のマイルストーンに関する具体的なタスクリスト、個々の機能開発の計画、次のステップなどを記載します。これはAIエージェントと共有する作業計画書です。
  - **更新タイミング**: 日々の開発活動を通じて、タスクの完了、新しいタスクの追加、計画の微調整があるたびに頻繁に更新します。

このハイブリッドアプローチにより、長期的なビジョンと日々の具体的な作業を両立させ、開発の透明性と効率性を高めます。

---
**このルールはプロジェクトの成長に合わせて更新されます。常に最新版を確認し、全員で高品質な開発を維持しましょう。**
