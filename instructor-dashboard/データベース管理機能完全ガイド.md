# 📊 データベース管理機能完全ガイド

## 🎯 概要

JupyterLab Cell Monitor Extensionシステムでは、2種類のデータベースを運用しています：

- **PostgreSQL**: 構造化データ（学生、セッション、設定等）
- **InfluxDB**: 時系列データ（パフォーマンスメトリクス、実行統計）

## 🗄️ データベース構成

### PostgreSQL (構造化データ)
```
📋 管理対象テーブル（15テーブル）
├── 👥 ユーザー管理
│   ├── students (70件) - 学生データ
│   ├── instructors (0件) - 講師データ
│   └── teams (12件) - チーム情報
├── 📚 学習管理
│   ├── sessions (67件) - 学習セッション
│   ├── notebooks (72件) - ノートブック
│   ├── cells (1,666件) - セル情報
│   └── cell_executions (2,831件) - セル実行履歴
├── 🎓 LMS機能
│   ├── classes (0件) - クラス
│   ├── class_assignments (0件) - 課題
│   ├── assignment_submissions (0件) - 提出物
│   └── student_classes (0件) - 履修情報
├── 🗺️ 教室管理
│   ├── classroom_maps (8件) - 教室マップ
│   └── team_positions (48件) - チーム配置
├── 📖 アクセス管理
│   └── notebook_accesses (0件) - ノートブックアクセス
└── ⚙️ システム管理
    └── system_settings (11件) - システム設定
```

### InfluxDB (時系列データ)
```
📈 時系列メトリクス
├── student_progress - 学習進捗データ
├── cell_execution_metrics - セル実行統計
├── performance_data - パフォーマンス指標
└── help_request_events - ヘルプ要求履歴
```

## 🖥️ PostgreSQL管理機能

### アクセス方法
1. **管理画面**: http://localhost:3000/admin
2. **「データベース管理」タブ**をクリック

### 🔍 主要機能

#### 1. データ検索・表示
```typescript
✅ 実装済み機能
• テーブル選択（15テーブル対応）
• 高度な検索・フィルタリング
• ページネーション（25/50/100件表示）
• ソート機能（作成日時、ID等）
• リアルタイム統計表示
```

#### 2. 安全な削除機能
```typescript
✅ セキュリティ機能
• 確認ダイアログ（削除前確認）
• 関連データの自動削除（外部キー制約対応）
• 削除順序の最適化
• エラーハンドリング強化
```

#### 3. システム監視
```typescript
✅ 監視機能
• DB接続状況リアルタイム監視
• テーブル別レコード数統計
• 総レコード数表示（現在5,737件）
• ヘルスチェック機能
```

### 🛡️ セキュリティ設計

#### 外部キー制約対応
```python
# 学生削除時の関連データ処理順序
1. cell_executions（セル実行履歴）
2. notebook_accesses（ノートブックアクセス）
3. student_classes（履修情報）
4. sessions（セッション）
5. students（学生本体）
```

#### 操作ログ
```python
# 全削除操作のログ記録
- 操作者ID、削除対象、実行時刻
- 関連データ削除件数
- エラー情報（失敗時）
```

### 📋 API エンドポイント一覧

```bash
# テーブル管理
GET    /api/v1/admin/database/tables          # テーブル一覧
POST   /api/v1/admin/database/search          # データ検索
DELETE /api/v1/admin/database/{table}/{id}   # レコード削除

# システム監視
GET    /api/v1/admin/database/stats           # DB統計
GET    /api/v1/admin/database/health          # 接続状況

# データメンテナンス
POST   /api/v1/admin/database/cleanup/old-sessions  # 古いセッション削除
```

### 🧪 テスト実行方法

```bash
# Docker環境でテスト実行
docker compose exec fastapi pytest tests/api/test_admin_database.py -v

# 特定テストのみ実行
docker compose exec fastapi pytest tests/api/test_admin_database.py::TestAdminDatabaseAPI::test_delete_record -v
```

## 🔧 InfluxDB管理方針

### 基本方針
**専用スクリプトによる管理が最適解**

理由：
- InfluxDBは自動メンテナンス機能内蔵
- Flux構文の複雑性
- UI実装コストvsメリット比較

### 🗑️ データクリーンアップ戦略

#### 自動削除ポリシー
```bash
# InfluxDBの自動データ保持ポリシー設定例
- 詳細データ: 30日保持
- 集約データ: 1年保持
- アーカイブ: 必要時手動エクスポート
```

#### 手動クリーンアップ
```bash
# 古いデータ削除（90日以上前）
./scripts/cleanup_old_metrics.py --days 90

# 特定期間のデータ削除
./scripts/cleanup_old_metrics.py --start 2025-01-01 --end 2025-02-01

# 特定学生のデータ削除
./scripts/cleanup_old_metrics.py --student student@example.com
```

### 📤 データエクスポート戦略

```bash
# 全期間データエクスポート
./scripts/export_influxdb_metrics.py --range all

# 期間指定エクスポート
./scripts/export_influxdb_metrics.py --range 30d
./scripts/export_influxdb_metrics.py --start 2025-01-01 --end 2025-02-01

# 学生別エクスポート
./scripts/export_influxdb_metrics.py --student student@example.com --range 7d
```

## 🚀 運用ワークフロー

### 📅 日次メンテナンス
```bash
1. PostgreSQL統計確認（管理画面）
2. InfluxDBヘルスチェック（システム監視）
3. 異常データの検出・対応
```

### 🗓️ 週次メンテナンス
```bash
1. 古いセッションデータクリーンアップ（PostgreSQL）
2. InfluxDBメトリクス容量チェック
3. パフォーマンストレンド分析
```

### 📆 月次メンテナンス
```bash
1. 古いInfluxDBデータ削除（90日以上前）
2. データベースバックアップ
3. ストレージ最適化
```

## 📈 パフォーマンス最適化

### PostgreSQL最適化
- **インデックス**: created_at, student_id, session_id
- **パーティション**: 月別テーブル分割検討
- **アーカイブ**: 1年以上前データの別DB移行

### InfluxDB最適化
- **バケット分離**: リアルタイム用/履歴用
- **ダウンサンプリング**: 古いデータの粒度削減
- **圧縮**: 自動圧縮設定最適化

## 🔒 セキュリティベストプラクティス

### アクセス制御
```typescript
✅ 実装済み
• 管理者権限必須（role: 'admin'）
• 削除操作の詳細ログ記録
• 確認ダイアログによる誤操作防止
```

### データ保護
```typescript
✅ 実装済み
• 関連データの整合性保証
• トランザクション管理
• エラー時の自動ロールバック
```

### 監査ログ
```typescript
📋 推奨実装
• 操作者追跡
• データ変更履歴
• アクセスパターン分析
```

## 🎓 使用例

### 学生データ管理
```bash
1. 管理画面で「students」テーブル選択
2. 問題のある学生を検索
3. 削除ボタンで関連データも含めて安全削除
4. 統計確認で削除結果を検証
```

### システムメンテナンス
```bash
1. 「データベース管理」タブで全体統計確認
2. InfluxDBスクリプトで古いメトリクス削除
3. ヘルスチェックで両DB状況確認
```

## 🧪 Docker環境でのテスト結果

### InfluxDBスクリプトテスト完了 (2025-08-31)

#### ✅ クリーンアップスクリプト (`cleanup_old_metrics.py`)
```bash
# テスト実行結果
docker compose exec fastapi python scripts/cleanup_old_metrics.py --stats
📊 総ポイント数: 48,341 (student_progress: 29,097, student_progress_v2: 19,244)

# ドライラン確認
docker compose exec fastapi python scripts/cleanup_old_metrics.py --days 120 --dry-run
🔍 削除対象: 29,097ポイント (正常動作確認)
```

#### ✅ エクスポートスクリプト (`export_influxdb_metrics.py`)
```bash
# 統計情報取得
docker compose exec fastapi python scripts/export_influxdb_metrics.py --stats
📊 エクスポート可能データ: 48,341ポイント

# 実際のデータエクスポート
docker compose exec fastapi python scripts/export_influxdb_metrics.py --range 7d --measurement student_progress
✅ エクスポート成功: 1,086レコード (0.2MB CSV)

docker compose exec fastapi python scripts/export_influxdb_metrics.py --range 30d
✅ エクスポート成功: 4,699レコード (1.0MB CSV)
```

#### 🔧 修正完了項目
1. **CSVフィールド不一致エラー**: 全レコードからフィールド名を動的収集
2. **Docker環境統合**: コンテナ内でのスクリプト実行確認
3. **実データ検証**: 21列フィールド、複数測定値対応

#### 📋 エクスポートデータ形式
```csv
cellContent,cellId,cellIndex,cellType,directory,duration,emailAddress,event,eventId,executionCount,measurement,notebook,notebookPath,resolvedBy,result,sessionId,success,table,teamName,time,userName
```

### 🚀 本番運用コマンド集

#### PostgreSQL管理（管理画面）
```bash
# アクセス: http://localhost:3000/admin → データベース管理タブ
# 機能: テーブル選択、検索、安全削除、統計監視
```

#### InfluxDB定期メンテナンス
```bash
# 月次: 古いデータクリーンアップ (90日以上前)
docker compose exec fastapi python scripts/cleanup_old_metrics.py --days 90

# 週次: データ統計確認
docker compose exec fastapi python scripts/cleanup_old_metrics.py --stats

# 必要時: 特定期間データエクスポート
docker compose exec fastapi python scripts/export_influxdb_metrics.py --range 30d

# 学生別データエクスポート
docker compose exec fastapi python scripts/export_influxdb_metrics.py --student student@example.com --range 7d
```

---

**運用準備完了** ✅  
PostgreSQL管理画面 + InfluxDB専用スクリプトによる効率的データベース運用が可能です。  
**Docker環境でのテスト実行済み** - 実データでの動作確認完了。