# 環境変数でNodeバージョンを指定可能
ARG NODE_VERSION=18-alpine
FROM node:${NODE_VERSION}

# 作業ディレクトリの設定
WORKDIR /app

# パッケージマネージャの最適化
RUN npm config set fund false && npm config set audit false

# 依存関係のコピーとインストール（Docker層キャッシュの活用）
COPY package*.json ./

# 開発依存関係を含むすべての依存関係をインストール
RUN npm install && npm cache clean --force

# アプリケーションソースコードのコピー
COPY . .

# 非rootユーザーでの実行（セキュリティ強化）
RUN addgroup -g 1001 -S nodejs && \
    adduser -S react -u 1001 -G nodejs && \
    chown -R react:nodejs /app

USER react

# ポート公開
EXPOSE 3000

# ヘルスチェック用のcurlインストール
USER root
RUN apk add --no-cache curl
USER react

# React開発サーバーの起動
CMD ["npm", "start"]
