# 📊 データベース管理機能実装計画

## 🎯 目的
AdminPanelに第3のタブとして、セキュアなデータベース管理機能を追加し、システム運用効率を向上させる。

## 🔍 現状分析

### 既存のアーキテクチャ
- **フロントエンド**: AdminPanel.tsx（2タブ構成：統合パフォーマンス監視、システム設定）
- **バックエンド**: `/admin` APIエンドポイント（設定管理のみ）
- **データベース**: 15テーブル（Student、Session、CellExecution等）

### 既存の管理機能
- SystemSettings：システム設定の表示・編集
- PerformanceMonitoring：統合パフォーマンス監視

## 🛡️ セキュリティ要件

### 1. 認証・認可
```typescript
// 管理者権限の検証
- role: 'admin' のユーザーのみアクセス可能
- JWT認証による権限チェック
- セッションタイムアウト（30分）
```

### 2. 操作ログ
```typescript
// 全DB操作の監査ログ
- 操作者ID、操作内容、対象データ、タイムスタンプ
- 削除操作の詳細記録
- エラー操作の記録
```

### 3. 安全な削除操作
```typescript
// ソフトデリート方式
- deleted_at フィールドによる論理削除
- 物理削除は30日後の自動実行
- 関連データの整合性チェック
```

## 📋 実装機能一覧

### 3️⃣ タブ3: データベース管理

#### 🔍 A. データ検索・表示機能
```typescript
1. テーブル選択ドロップダウン
   - 15テーブルから選択（Student、Session、CellExecution等）
   - テーブル別スキーマ情報表示

2. 高度な検索機能
   - フィルタリング：日付範囲、ユーザーID、セッション状態
   - ソート機能：作成日時、更新日時、ID順
   - ページネーション：100件単位表示

3. データ表示
   - テーブル形式での詳細表示
   - JSON形式でのraw data表示
   - 関連データのリンク表示
```

#### 🗑️ B. データ管理機能
```typescript
1. 安全な削除操作
   - 個別レコード削除（確認ダイアログ付き）
   - 一括削除（条件指定：日付範囲、ユーザー等）
   - ソフトデリート実装

2. データクリーンアップ
   - 古いセッションデータ削除（30日以上前）
   - 孤立したノートブックデータ削除
   - 無効なユーザーアカウント削除

3. データエクスポート
   - CSV形式エクスポート
   - JSON形式エクスポート
   - 日付範囲指定エクスポート
```

#### 📊 C. システム健全性監視
```typescript
1. データベース統計
   - テーブル別行数表示
   - ストレージ使用量
   - インデックス効率状況

2. 接続状況監視
   - アクティブ接続数
   - 長時間実行クエリ検出
   - デッドロック検出

3. パフォーマンス指標
   - 平均クエリ実行時間
   - データベース負荷状況
   - メモリ使用量
```

#### 📝 D. 監査・ログ機能
```typescript
1. 操作履歴表示
   - 管理者操作ログ一覧
   - 削除操作の詳細履歴
   - エラー操作の記録

2. セキュリティ監視
   - 不審なアクセスパターン検出
   - 大量削除操作のアラート
   - 権限外アクセス試行の記録
```

## 🏗️ 技術実装計画

### Phase 1: バックエンドAPI実装
```python
# fastapi_server/api/endpoints/admin.py に追加
1. データ検索エンドポイント
   - GET /admin/tables/{table_name}/data
   - GET /admin/tables/{table_name}/schema
   - GET /admin/search

2. データ管理エンドポイント
   - DELETE /admin/tables/{table_name}/{record_id}
   - POST /admin/cleanup/old-sessions
   - POST /admin/export/{table_name}

3. システム健全性エンドポイント
   - GET /admin/database/stats
   - GET /admin/database/connections
   - GET /admin/database/performance
```

### Phase 2: フロントエンド実装
```typescript
# instructor-dashboard/src/pages/admin/components/
1. DatabaseManagement.tsx
   - メインDB管理コンポーネント
   - テーブル選択とデータ表示

2. DataTable.tsx
   - 動的テーブル表示コンポーネント
   - ソート・フィルタリング機能

3. DeleteConfirmation.tsx
   - 安全な削除確認ダイアログ
   - 関連データ影響の表示
```

### Phase 3: セキュリティ強化
```typescript
1. 権限チェック強化
   - フロントエンド：管理者権限UI表示制御
   - バックエンド：全エンドポイントで権限検証

2. 操作ログ実装
   - 新テーブル：AdminOperationLog
   - 全削除操作の自動記録

3. レート制限
   - 削除操作：1分間に10回まで
   - 大量データエクスポート：5分間に1回
```

## 📅 実装スケジュール

### Week 1: 基盤実装
- [ ] AdminPanel.tsxに3番目のタブ追加
- [ ] バックエンドAPIエンドポイント基本実装
- [ ] データ検索・表示機能実装

### Week 2: 管理機能実装
- [ ] 安全な削除機能実装
- [ ] データクリーンアップ機能
- [ ] エクスポート機能実装

### Week 3: セキュリティ・監査
- [ ] 操作ログシステム実装
- [ ] 権限チェック強化
- [ ] セキュリティテスト実施

### Week 4: テスト・最適化
- [ ] ユニットテスト実装
- [ ] 統合テスト実施
- [ ] パフォーマンス最適化

## 🚨 リスク管理

### 高リスク操作
1. **大量データ削除**: バックアップ必須、段階的削除実装
2. **本番データアクセス**: Read-Only モード実装検討
3. **権限昇格攻撃**: 多要素認証導入検討

### 緩和策
1. **データ保護**: 自動バックアップ + 復旧手順
2. **操作制限**: レート制限 + 管理者承認フロー
3. **監視強化**: リアルタイム異常検知 + アラート

## 📏 成功指標

1. **運用効率**: データ管理作業時間50%削減
2. **データ品質**: 孤立データ95%削減
3. **セキュリティ**: セキュリティインシデント0件
4. **可用性**: システム稼働率99.9%維持

## 🔄 継続的改善

1. **月次レビュー**: 使用状況分析とUI改善
2. **四半期監査**: セキュリティ設定とログ分析
3. **年次更新**: 新機能追加とアーキテクチャ見直し

---

**実装準備完了** ✅
セキュリティベストプラクティスに基づく段階的実装により、安全で効率的なDB管理機能を提供します。