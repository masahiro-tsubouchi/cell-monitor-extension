# JupyterLab Cell Monitor Extension 手動インストール手順

## ⚠️ Windows環境の重要な注意事項

**Windows環境でJupyterLabを使用している方は、必ずこのセクションを先にお読みください。**

### 🔒 lockedExtensions問題について

Windows環境では、拡張機能を間違った方法でインストールすると「lockedExtensions」状態になり、**後で無効化・アンインストールができなくなる**問題があります。

**問題が起こる原因**:
- JupyterLabがシステムレベル（管理者権限）でインストールされている場合
- Anaconda/Minicondaのデフォルトインストール環境
- `pip install`（`--user`フラグなし）でのインストール

**問題の症状**:
```
❌ `sys_prefix` level settings are read-only, using `user` level for migration to `lockedExtensions`
❌ PermissionError: [Errno 13] Permission denied: page_config.json
❌ 拡張機能の無効化・アンインストールボタンが効かない
```

### 🛡️ 安全なインストール方法（Windows推奨）

#### ✅ 方法1: --userフラグを使用（最推奨）
```powershell
# PowerShellまたはコマンドプロンプトで実行
pip install --user cell_monitor-1.1.0-py3-none-any.whl
```

**メリット**:
- ✅ ユーザーが自由に有効化・無効化可能
- ✅ 管理者権限不要
- ✅ アンインストールが簡単
- ✅ 他のユーザーに影響しない

#### ✅ 方法2: 仮想環境を使用
```powershell
# Anaconda環境の場合
conda create -n jupyter-env python=3.12
conda activate jupyter-env
pip install cell_monitor-1.1.0-py3-none-any.whl
```

#### ❌ 避けるべき方法
```powershell
# ❌ これはやらないでください（システムレベルインストール）
pip install cell_monitor-1.1.0-py3-none-any.whl

# ❌ 管理者権限での実行も避けてください
# 「管理者として実行」でコマンドプロンプトを開いてのインストール
```

---

## 🚀 新しい開発フロー

これまでの自動ビルド・インストール方式から、**手動インストール方式**に変更されました。

### Phase 1: 拡張機能のビルド

```bash
# 1. 拡張機能をビルド（.whlパッケージ生成）
./build-extension.sh
```

**生成されるファイル**: `cell-monitor-extension/dist/cell_monitor-1.1.0-py3-none-any.whl`

### Phase 2: JupyterLabコンテナの起動

```bash
# 2. 簡素化されたJupyterLabコンテナを起動
docker compose up -d jupyterlab
```

**特徴**:
- 拡張機能の自動インストール **なし**
- 純粋なJupyterLab環境
- `/app/dist` に拡張機能パッケージがマウント済み

### Phase 3: 手動インストール

#### 方法1: コンテナ内でのpipインストール

```bash
# コンテナ内に入る
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 bash

# 拡張機能をインストール（コンテナ内では--userは不要）
pip install /app/dist/cell_monitor-1.1.1-py3-none-any.whl

# JupyterLabを再起動
# （コンテナを停止・再起動）
exit
docker compose restart jupyterlab
```

#### 方法2: JupyterLab UI経由でのインストール

1. **JupyterLabにアクセス**: http://localhost:8888 (token: easy)
2. **Extension Managerを開く**: 左サイドバーの拡張機能アイコン
3. **From File**: 「Install from file」をクリック
4. **ファイル選択**: `/app/dist/cell_monitor-1.1.0-py3-none-any.whl` を選択
5. **インストール実行**: 「Install」ボタンをクリック
6. **再起動**: JupyterLabのリフレッシュまたはコンテナ再起動

## 📋 動作確認

### 1. 拡張機能の有効化確認

JupyterLabのログで以下を確認:
```
[I] cell_monitor | extension was successfully loaded.
```

### 2. フロントエンド拡張機能の確認

JupyterLab Settings → Advanced Settings Editor → Cell Monitor で設定が表示されることを確認:
```json
{
  "serverUrl": "http://fastapi:8000/api/v1/events",
  "userId": "",
  "userName": "Anonymous"
}
```

### 3. セル実行監視の動作確認

1. ノートブックを作成
2. セルを実行
3. FastAPIサーバーのログでイベント受信を確認

## 🔄 開発時の更新フロー

拡張機能を更新した場合:

```bash
# 1. 拡張機能を再ビルド
./build-extension.sh

# 2. JupyterLabコンテナ内で再インストール
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 bash -c "pip install --force-reinstall /app/dist/cell_monitor-1.1.0-py3-none-any.whl"

# 3. JupyterLabを再起動
docker compose restart jupyterlab
```

## 🎯 メリット

- **開発効率**: 拡張機能の変更時にJupyterLabコンテナ全体の再ビルド不要
- **本番対応**: 実際の配布・インストールプロセスと同一
- **デバッグ改善**: 拡張機能とJupyterLabの問題切り分けが容易
- **柔軟性**: 複数バージョンの拡張機能テストが可能

## 🖥️ Windows環境での実際のインストール手順

### 事前準備

1. **コマンドプロンプトまたはPowerShellを普通に開く**（管理者として実行は**しない**）
2. **現在のJupyterLab環境を確認**:
   ```powershell
   # JupyterLabがどこにインストールされているか確認
   where jupyter
   jupyter --version
   ```

### インストール実行

```powershell
# Step 1: ダウンロードしたwhlファイルの場所に移動
cd C:\Users\{ユーザー名}\Downloads

# Step 2: ユーザーレベルでインストール（重要：--userフラグ必須）
pip install --user cell_monitor-1.1.0-py3-none-any.whl

# Step 3: JupyterLabを再起動
# 既存のJupyterLabを閉じてから再度起動
jupyter lab
```

### インストール成功の確認

```powershell
# 拡張機能の一覧表示
jupyter labextension list

# 以下のような表示が出れば成功
# JupyterLab v4.x.x
# cell-monitor v1.1.0 enabled OK
```

### 🔧 アンインストール方法（Windows）

正しくインストールできていれば、簡単にアンインストール可能です：

```powershell
# 方法1: pipでアンインストール
pip uninstall cell-monitor

# 方法2: JupyterLab UIから
# Extension Manager → Installed → cell-monitor → Uninstall
```

## ⚠️ トラブルシューティング

### 🚨 「lockedExtensions」エラーが発生した場合

**症状**: 拡張機能の無効化・アンインストールができない

**解決方法**:

#### Step 1: 現在のインストール状況確認
```powershell
# インストール場所を確認
pip show cell-monitor

# システムレベルインストールの場合、Locationが以下のようになる
# Location: C:\ProgramData\Anaconda3\lib\site-packages  ← 問題のあるパターン
# Location: C:\Users\{ユーザー名}\AppData\Local\lib\site-packages  ← 正常なパターン
```

#### Step 2: 強制アンインストール（管理者権限必要）
```powershell
# 管理者としてコマンドプロンプトを開いて実行
pip uninstall cell-monitor --yes

# JupyterLabのキャッシュクリア
jupyter lab clean
jupyter lab build
```

#### Step 3: 正しい方法で再インストール
```powershell
# 通常のコマンドプロンプトに戻って実行
pip install --user cell_monitor-1.1.0-py3-none-any.whl
```

### 💡 予防策

1. **常に --user フラグを使用**
2. **管理者権限でコマンドプロンプトを開かない**
3. **仮想環境の使用を検討**
4. **企業環境では IT部門に相談**

---

## ⚠️ その他のトラブルシューティング

### 拡張機能が表示されない場合

```bash
# JupyterLabの拡張機能一覧を確認
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 jupyter labextension list

# インストール状況を確認
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 pip list | grep cell-monitor
```

### 設定が反映されない場合

```bash
# JupyterLabの設定ディレクトリを確認
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 ls -la ~/.jupyter/lab/user-settings/
```

### キャッシュ問題の解決

#### Docker環境（開発者向け）
```bash
# JupyterLabのキャッシュをクリア
docker exec -it jupyter-extensionver2-claude-code-jupyterlab-1 rm -rf ~/.cache/jupyterlab
docker compose restart jupyterlab
```

#### Windows環境（一般ユーザー向け）
```powershell
# JupyterLabのキャッシュクリア
jupyter lab clean

# 必要に応じてJupyterLabの再ビルド
jupyter lab build

# JupyterLabを再起動
```

### 権限エラーが発生する場合

```powershell
# 現在のユーザーのPythonパッケージディレクトリを確認
python -m site --user-site

# そのディレクトリの権限を確認し、必要に応じて修正
# または別のPython環境（Anaconda等）の使用を検討
```

## 📞 サポート情報

### よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 拡張機能が無効化できない | システムレベルインストール | `--user`で再インストール |
| PermissionError | 管理者権限でのインストール | 権限を下げて再インストール |
| 拡張機能が見つからない | パッケージパスの問題 | 仮想環境の使用 |
| ビルドエラー | Node.js環境の問題 | JupyterLabの再インストール |

### 環境別推奨インストール方法

| 環境 | 推奨方法 | コマンド例 |
|------|----------|------------|
| **Windows個人PC** | `--user`フラグ | `pip install --user package.whl` |
| **Windows企業環境** | 仮想環境 | `conda create -n jupyter-env` |
| **macOS/Linux** | 仮想環境 | `python -m venv jupyter-env` |
| **開発環境** | Docker | `docker compose up` |