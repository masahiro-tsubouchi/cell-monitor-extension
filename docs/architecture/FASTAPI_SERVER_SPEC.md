# FastAPI Server è©³ç´°ä»•æ§˜æ›¸

> **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
> **æœ€çµ‚æ›´æ–°æ—¥**: 2025-01-19
> **å¯¾è±¡**: é–‹ç™ºè€…ãƒ»é‹ç”¨æ‹…å½“è€…

## ğŸ“‹ æ¦‚è¦

JupyterLab Cell Monitor Extension ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¯ã€å­¦ç¿’é€²æ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆLMSï¼‰ã¨ã—ã¦è¨­è¨ˆã•ã‚ŒãŸæœ¬æ ¼çš„ãªFastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã‚»ãƒ«å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆã®åé›†ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã€ã‚¯ãƒ©ã‚¹ãƒ»èª²é¡Œç®¡ç†æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
```
JupyterLab Extension â†’ FastAPI Server â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¾¤
                    â†“
               WebSocketé€šçŸ¥
                    â†“
            ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **APIå±¤**: RESTful API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å±¤**: éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å‡¦ç†
- **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å±¤**: PostgreSQLï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼‰+ InfluxDBï¼ˆæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼‰
- **é€šä¿¡å±¤**: Redis Pub/Sub + WebSocket
- **ãƒ†ã‚¹ãƒˆå±¤**: E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–æ©Ÿèƒ½

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
fastapi_server/
â”œâ”€â”€ main.py                    # FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
â”œâ”€â”€ requirements.txt           # ä¾å­˜é–¢ä¿‚å®šç¾©
â”œâ”€â”€ Dockerfile                 # ã‚³ãƒ³ãƒ†ãƒŠå®šç¾©
â”œâ”€â”€ pytest.ini               # ãƒ†ã‚¹ãƒˆè¨­å®š
â”œâ”€â”€ api/                      # APIå®šç¾©
â”‚   â”œâ”€â”€ api.py               # ãƒ«ãƒ¼ã‚¿ãƒ¼çµ±åˆ
â”‚   â””â”€â”€ endpoints/           # å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
â”‚       â”œâ”€â”€ events.py        # ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡API
â”‚       â”œâ”€â”€ test_events.py   # ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ™ãƒ³ãƒˆAPI
â”‚       â”œâ”€â”€ websocket.py     # WebSocketé€šä¿¡
â”‚       â”œâ”€â”€ cell_monitor.py  # ã‚»ãƒ«ç›£è¦–æ©Ÿèƒ½
â”‚       â”œâ”€â”€ progress.py      # é€²æ—ç®¡ç†
â”‚       â”œâ”€â”€ classes.py       # ã‚¯ãƒ©ã‚¹ç®¡ç†API (LMS)
â”‚       â”œâ”€â”€ assignments.py   # èª²é¡Œç®¡ç†API (LMS)
â”‚       â””â”€â”€ submissions.py   # æå‡ºç®¡ç†API (LMS)
â”œâ”€â”€ core/                    # å…±é€šæ©Ÿèƒ½ãƒ»è¨­å®š
â”‚   â”œâ”€â”€ config.py           # ç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ connection_manager.py # WebSocketæ¥ç¶šç®¡ç†
â”‚   â””â”€â”€ error_logger.py     # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡¦ç†
â”œâ”€â”€ schemas/                 # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©
â”‚   â”œâ”€â”€ event.py            # EventDataã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ cell_monitor.py     # ã‚»ãƒ«ç›£è¦–ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ progress.py         # é€²æ—ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ student.py          # å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ db/                     # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
â”‚   â”œâ”€â”€ models.py           # SQLAlchemyãƒ¢ãƒ‡ãƒ«å®šç¾©
â”‚   â”œâ”€â”€ base.py             # DBåŸºåº•ã‚¯ãƒ©ã‚¹
â”‚   â”œâ”€â”€ session.py          # DBæ¥ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ influxdb_client.py  # InfluxDBæ¥ç¶šãƒ»æ“ä½œ
â”‚   â””â”€â”€ redis_client.py     # Redisæ¥ç¶šãƒ»Pub/Sub
â”œâ”€â”€ crud/                   # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
â”‚   â””â”€â”€ crud_student.py     # å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿CRUD
â”œâ”€â”€ worker/                 # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
â”‚   â”œâ”€â”€ main.py            # ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ¡ã‚¤ãƒ³å‡¦ç†
â”‚   â”œâ”€â”€ event_router.py    # ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â””â”€â”€ error_handler.py   # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â”œâ”€â”€ tests/                 # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
â””â”€â”€ static/               # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ”Œ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜

### ãƒ¡ã‚¤ãƒ³API

#### POST `/api/v1/events`
**æ¦‚è¦**: JupyterLabã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿å—ä¿¡
**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: `List[EventData]`
**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: `{"message": "N events received and queued for processing."}`
**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. Redis Pub/Subãƒãƒ£ãƒ³ãƒãƒ«ã¸é…ä¿¡
3. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ¼ã‚«ãƒ¼ã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†

#### WebSocket `/ws`
**æ¦‚è¦**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥é…ä¿¡
**ç”¨é€”**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ç›£è¦–ç”»é¢ã¸ã®å³åº§ã®çŠ¶æ³é€šçŸ¥
**ãƒ‡ãƒ¼ã‚¿å½¢å¼**: JSONå½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿

### ãƒ†ã‚¹ãƒˆç”¨API

#### POST `/api/v1/test/events/{test_id}`
**æ¦‚è¦**: E2Eãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜
**ç”¨é€”**: è‡ªå‹•ãƒ†ã‚¹ãƒˆã§ã®ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ç¢ºèª
**ä¿æŒæœŸé–“**: 10åˆ†é–“ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰

#### GET `/api/v1/test/events/{test_id}`
**æ¦‚è¦**: ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ãƒ»æ¤œè¨¼

#### DELETE `/api/v1/test/events/{test_id}`
**æ¦‚è¦**: ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªã‚¢

#### GET `/api/v1/test/events`
**æ¦‚è¦**: ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆIDä¸€è¦§å–å¾—

### LMSæ©Ÿèƒ½API

#### Classes API (`/api/v1/classes`)
**æ¦‚è¦**: ã‚¯ãƒ©ã‚¹ãƒ»æˆæ¥­ç®¡ç†æ©Ÿèƒ½

- **POST `/api/v1/classes`**: æ–°è¦ã‚¯ãƒ©ã‚¹ä½œæˆ
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `ClassCreate` (name, class_code, description)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassResponse` (id, name, class_code, description, created_at, updated_at)
  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: class_codeé‡è¤‡ãƒã‚§ãƒƒã‚¯

- **GET `/api/v1/classes`**: ã‚¯ãƒ©ã‚¹ä¸€è¦§å–å¾—
  - ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: skip, limit (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `List[ClassResponse]`

- **GET `/api/v1/classes/{class_id}`**: ç‰¹å®šã‚¯ãƒ©ã‚¹å–å¾—
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **PUT `/api/v1/classes/{class_id}`**: ã‚¯ãƒ©ã‚¹æƒ…å ±æ›´æ–°
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `ClassUpdate` (éƒ¨åˆ†æ›´æ–°å¯¾å¿œ)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **DELETE `/api/v1/classes/{class_id}`**: ã‚¯ãƒ©ã‚¹å‰Šé™¤
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

#### Assignments API (`/api/v1/assignments`)
**æ¦‚è¦**: èª²é¡Œç®¡ç†æ©Ÿèƒ½

- **POST `/api/v1/assignments`**: æ–°è¦èª²é¡Œä½œæˆ
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `ClassAssignmentCreate` (class_id, notebook_id, title, description, due_date)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassAssignmentResponse`
  - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„: class_id, notebook_id ã®å­˜åœ¨ç¢ºèª

- **GET `/api/v1/assignments`**: èª²é¡Œä¸€è¦§å–å¾—
  - ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: skip, limit, class_id (ã‚¯ãƒ©ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `List[ClassAssignmentResponse]`

- **GET `/api/v1/assignments/{assignment_id}`**: ç‰¹å®šèª²é¡Œå–å¾—
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassAssignmentResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **PUT `/api/v1/assignments/{assignment_id}`**: èª²é¡Œæƒ…å ±æ›´æ–°
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `ClassAssignmentUpdate` (éƒ¨åˆ†æ›´æ–°å¯¾å¿œ)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassAssignmentResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **DELETE `/api/v1/assignments/{assignment_id}`**: èª²é¡Œå‰Šé™¤
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `ClassAssignmentResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

#### Submissions API (`/api/v1/submissions`)
**æ¦‚è¦**: èª²é¡Œæå‡ºç®¡ç†æ©Ÿèƒ½

- **POST `/api/v1/submissions`**: æ–°è¦æå‡ºä½œæˆ
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `AssignmentSubmissionCreate` (assignment_id, student_id, notebook_content, submitted_at)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `AssignmentSubmissionResponse`
  - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„: assignment_id, student_id ã®å­˜åœ¨ç¢ºèª

- **GET `/api/v1/submissions`**: æå‡ºä¸€è¦§å–å¾—
  - ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: skip, limit, assignment_id, student_id (ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `List[AssignmentSubmissionResponse]`

- **GET `/api/v1/submissions/{submission_id}`**: ç‰¹å®šæå‡ºå–å¾—
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `AssignmentSubmissionResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **PUT `/api/v1/submissions/{submission_id}`**: æå‡ºæƒ…å ±æ›´æ–°
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `AssignmentSubmissionUpdate` (éƒ¨åˆ†æ›´æ–°å¯¾å¿œ)
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `AssignmentSubmissionResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

- **DELETE `/api/v1/submissions/{submission_id}`**: æå‡ºå‰Šé™¤
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `AssignmentSubmissionResponse` ã¾ãŸã¯ 404ã‚¨ãƒ©ãƒ¼

## ğŸ”— JupyterLabæ‹¡å¼µæ©Ÿèƒ½ã¨ã®é€£æº

### ãƒ‡ãƒ¼ã‚¿é€£æºãƒ•ãƒ­ãƒ¼
```
JupyterLabæ‹¡å¼µæ©Ÿèƒ½ â†’ FastAPIã‚µãƒ¼ãƒãƒ¼ â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¾¤
        â†‘                     â†“
        â””â”€â”€ WebSocket â† ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
```

### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³
| **æ‹¡å¼µæ©Ÿèƒ½ã‚¤ãƒ™ãƒ³ãƒˆ** | **é€ä¿¡å…ˆAPI** | **ç”¨é€”** | **é »åº¦** |
|---------------------|--------------|----------|----------|
| `cell_execution_start` | `POST /api/v1/events` | ã‚»ãƒ«å®Ÿè¡Œé–‹å§‹é€šçŸ¥ | ã‚»ãƒ«å®Ÿè¡Œæ™‚ |
| `cell_execution_complete` | `POST /api/v1/events` | ã‚»ãƒ«å®Ÿè¡Œå®Œäº†ãƒ»çµæœè¨˜éŒ² | ã‚»ãƒ«å®Ÿè¡Œå®Œäº†æ™‚ |
| `cell_execution_error` | `POST /api/v1/events` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿè¨˜éŒ² | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ |
| `notebook_save` | `POST /api/v1/events` | ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä¿å­˜è¨˜éŒ² | ä¿å­˜æ™‚ |
| `session_start` | `POST /api/v1/events` | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹è¨˜éŒ² | JupyterLabèµ·å‹•æ™‚ |
| `session_end` | `POST /api/v1/events` | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†è¨˜éŒ² | JupyterLabçµ‚äº†æ™‚ |

### LMSæ©Ÿèƒ½é€£æº
| **æ‹¡å¼µæ©Ÿèƒ½æ“ä½œ** | **APIå‘¼ã³å‡ºã—** | **ãƒ‡ãƒ¼ã‚¿äº¤æ›** |
|-----------------|----------------|----------------|
| èª²é¡Œä¸€è¦§è¡¨ç¤º | `GET /api/v1/assignments?class_id={id}` | èª²é¡Œãƒªã‚¹ãƒˆå–å¾— |
| èª²é¡Œæå‡º | `POST /api/v1/submissions` | ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å†…å®¹é€ä¿¡ |
| æå‡ºå±¥æ­´ç¢ºèª | `GET /api/v1/submissions?student_id={id}` | æå‡ºçŠ¶æ³å–å¾— |
| é€²æ—ç¢ºèª | WebSocket `progress:{student_id}` | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—å—ä¿¡ |

### WebSocketã‚¤ãƒ™ãƒ³ãƒˆ
| **ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥** | **ãƒãƒ£ãƒ³ãƒãƒ«** | **ãƒ‡ãƒ¼ã‚¿å½¢å¼** | **ç”¨é€”** |
|----------------|----------------|---------------|----------|
| `execution_update` | `progress:{student_id}` | å®Ÿè¡ŒçŠ¶æ…‹æƒ…å ± | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤º |
| `assignment_graded` | `notifications:{student_id}` | æ¡ç‚¹çµæœé€šçŸ¥ | æˆç¸¾é€šçŸ¥ |
| `system_message` | `broadcast` | ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | å…¨ä½“é€šçŸ¥ |

### ãƒ‡ãƒ¼ã‚¿é€ä¿¡æœ€é©åŒ–
- **ãƒãƒƒãƒå‡¦ç†**: æœ€å¤§100ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦é€ä¿¡
- **åœ§ç¸®**: gzipåœ§ç¸®ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºå‰Šæ¸›
- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ**: IndexedDBã§ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
- **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å†é€

**è©³ç´°ä»•æ§˜**: `docs/architecture/EVENT_FLOW.md` ã‚’å‚ç…§

## ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### PostgreSQLï¼ˆæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼‰

#### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ
1. **students**: å­¦ç”Ÿãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
2. **sessions**: JupyterLabã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
3. **notebooks**: ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯æƒ…å ±
4. **cells**: ã‚»ãƒ«æƒ…å ±
5. **cell_executions**: ã‚»ãƒ«å®Ÿè¡Œå±¥æ­´
6. **classes**: ã‚¯ãƒ©ã‚¹ãƒ»æˆæ¥­ç®¡ç†
7. **student_classes**: å­¦ç”Ÿ-ã‚¯ãƒ©ã‚¹é–¢é€£ä»˜ã‘
8. **class_assignments**: ã‚¯ãƒ©ã‚¹èª²é¡Œç®¡ç†
9. **assignment_submissions**: èª²é¡Œæå‡ºç®¡ç†
10. **notebook_accesses**: ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´

#### ä¸»è¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```
Student 1:N Session 1:N CellExecution N:1 Cell N:1 Notebook
Student N:M Class (via StudentClass)
Class 1:N ClassAssignment N:1 Notebook
Student 1:N AssignmentSubmission N:1 ClassAssignment
```

### InfluxDBï¼ˆæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼‰

#### Measurement: `student_progress`
**ã‚¿ã‚°ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ï¼‰**:
- `userId`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
- `event`: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
- `notebook`: ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯å
- `cellType`: ã‚»ãƒ«ã‚¿ã‚¤ãƒ—
- `sessionId`: ã‚»ãƒƒã‚·ãƒ§ãƒ³ID

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰**:
- `cellId`: ã‚»ãƒ«ID
- `notebookPath`: ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒ‘ã‚¹
- `executionCount`: å®Ÿè¡Œå›æ•°
- `success`: å®Ÿè¡ŒæˆåŠŸãƒ•ãƒ©ã‚°
- `duration`: å®Ÿè¡Œæ™‚é–“

### Redisï¼ˆPub/Subãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

#### ãƒãƒ£ãƒ³ãƒãƒ«
- `student_progress_notifications`: ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥é…ä¿¡

## âš™ï¸ ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼

### 1. ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
```
JupyterLab â†’ POST /api/v1/events â†’ FastAPI â†’ Redis Pub/Sub
```

### 2. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
```
Redis Subscriber â†’ Event Router â†’ Handler Functions
                                â†“
                    PostgreSQL + InfluxDB æ›¸ãè¾¼ã¿
```

### 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
```
Redis Pub/Sub â†’ WebSocket Manager â†’ æ¥ç¶šä¸­ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```

### 4. ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—åˆ¥å‡¦ç†

#### `cell_execution`
- ã‚»ãƒ«å®Ÿè¡Œå±¥æ­´ã‚’PostgreSQLã«è¨˜éŒ²
- å®Ÿè¡Œãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’InfluxDBã«ä¿å­˜
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥

#### `notebook_save`
- ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä¿å­˜å±¥æ­´ã‚’è¨˜éŒ²
- ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’InfluxDBã«ä¿å­˜

#### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡¦ç†
- åŸºæœ¬çš„ãªé€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦å‡¦ç†
- å­¦ç”Ÿæƒ…å ±ã®è‡ªå‹•ä½œæˆãƒ»æ›´æ–°

## ğŸ”§ è¨­å®šé …ç›®

### ç’°å¢ƒå¤‰æ•°ï¼ˆ`core/config.py`ï¼‰

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
- `PROJECT_NAME`: "Student Progress Tracker API"
- `PROJECT_VERSION`: "1.0.0"
- `API_V1_STR`: "/api/v1"

#### CORSè¨­å®š
- `BACKEND_CORS_ORIGINS`: è¨±å¯ã‚ªãƒªã‚¸ãƒ³ï¼ˆé–‹ç™ºæ™‚ã¯["*"]ï¼‰

#### PostgreSQLè¨­å®š
- `POSTGRES_USER`: "admin"
- `POSTGRES_PASSWORD`: "secretpassword"
- `POSTGRES_SERVER`: "postgres"
- `POSTGRES_PORT`: 5432
- `POSTGRES_DB`: "progress_db"

#### InfluxDBè¨­å®š
- `INFLUXDB_URL`: "http://influxdb:8086"
- `INFLUXDB_TOKEN`: "my-super-secret-token"
- `INFLUXDB_ORG`: "my-org"
- `INFLUXDB_BUCKET`: "progress_bucket"

#### Redisè¨­å®š
- `REDIS_HOST`: "redis"
- `REDIS_PORT`: 6379

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ä¿¡é ¼æ€§

### ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
- **InfluxDBæ›¸ãè¾¼ã¿**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
- **ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†**: å¤±æ•—æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
- **Redisæ¥ç¶š**: æ¥ç¶šå¤±æ•—æ™‚ã®å†æ¥ç¶šå‡¦ç†

### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
- æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›
- ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«åˆ¥ã®è©³ç´°ãƒ­ã‚°
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®åŒ…æ‹¬çš„è¨˜éŒ²

### ç›£è¦–ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ãƒ»çµ‚äº†ãƒ­ã‚°
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ…‹ç›£è¦–
- Redis Pub/Subæ¥ç¶šçŠ¶æ…‹ç›£è¦–

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

### E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–
- **Playwright**: JupyterLabè‡ªå‹•æ“ä½œ
- **pytest**: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè¡Œ
- **Docker**: çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **ãƒ†ã‚¹ãƒˆç”¨API**: ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ç¢ºèªæ©Ÿèƒ½

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•
```bash
# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./run_e2e_tests.sh

# å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./run_tests_in_docker.sh

# ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³E2Eãƒ†ã‚¹ãƒˆ
python test_e2e_standalone.py
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### è¨­è¨ˆç›®æ¨™
- **åŒæ™‚æ¥ç¶š**: 200ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ
- **ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†**: éåŒæœŸãƒ»ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: èª­ã¿æ›¸ãåˆ†é›¢å¯¾å¿œ
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ã‚³ãƒ³ãƒ†ãƒŠãƒ™ãƒ¼ã‚¹æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œ

### æœ€é©åŒ–è¦ç´ 
- **ãƒãƒƒãƒæ›¸ãè¾¼ã¿**: InfluxDBã¸ã®åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- **æ¥ç¶šãƒ—ãƒ¼ãƒ«**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®åŠ¹ç‡åŒ–
- **éåŒæœŸå‡¦ç†**: ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®ä¸¦åˆ—åŒ–
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: æ¤œç´¢ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### Dockeræ§‹æˆ
- **FastAPI**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼
- **PostgreSQL**: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- **InfluxDB**: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- **Redis**: Pub/Subãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
```bash
# é–‹ç™ºç’°å¢ƒ
docker compose up -d

# æœ¬ç•ªç’°å¢ƒ
docker compose -f docker-compose.prod.yml up -d
```

## ğŸ”® æ‹¡å¼µå¯èƒ½æ€§

### è¿½åŠ å¯èƒ½ãªæ©Ÿèƒ½
- **èªè¨¼ãƒ»èªå¯**: JWT/OAuth2å¯¾å¿œ
- **APIåˆ¶é™**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»ã‚¯ã‚©ãƒ¼ã‚¿ç®¡ç†
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: Prometheus/Grafanaé€£æº
- **ãƒ­ã‚°é›†ç´„**: ELKã‚¹ã‚¿ãƒƒã‚¯é€£æº
- **é€šçŸ¥**: Slack/Teamsé€£æº
- **AIåˆ†æ**: å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†ææ©Ÿèƒ½

### ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ 
```python
# worker/event_router.py
@with_retry
async def handle_custom_event(event_data: Dict[str, Any], db: Session):
    # ã‚«ã‚¹ã‚¿ãƒ å‡¦ç†å®Ÿè£…
    pass

# ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ²
event_router.register_handler("custom_event", handle_custom_event)
```

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [API ãƒ‡ãƒ¼ã‚¿ä»•æ§˜æ›¸](./API_DATA_SPEC.md)
- [ãƒ“ãƒ«ãƒ‰ãƒ»é…å¸ƒã‚¬ã‚¤ãƒ‰](../development/BUILD_AND_DISTRIBUTION.md)
- [é–‹ç™ºè¨ˆç”»æ›¸](../development/DEVELOPMENT_PLAN.md)
- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](../ROADMAP.md)
