# Jupyter拡張機能とFastAPIサーバー連携のデバッグとアーキテクチャ改善

## 1. はじめに

このドキュメントは、JupyterLab拡張機能（cell-monitor-extension）とFastAPIサーバー間の通信で発生した一連のエラー（404, 405, 422）のデバッグプロセスと、その解決策として導入したベストプラクティスに基づく最終的なアーキテクチャについて詳述します。

## 2. 初期問題と調査

当初、JupyterLab拡張機能から送信される進捗データがサーバーに届かず、以下のエラーが断続的に発生していました。

- `404 Not Found`: APIのパスが一致しない。
- `405 Method Not Allowed`: パスは存在するが、HTTPメソッド（GET/POST）が許可されていない。
- `422 Unprocessable Entity`: パスは正しいが、送信されたデータの形式がサーバーの期待と異なる。

これらの問題は、クライアント（拡張機能）とサーバーのAPI設計に関する想定の不一致が原因でした。

### 調査プロセス

1.  **APIパスの試行錯誤:** 当初、サーバー側のAPIパスを拡張機能の動作に合わせる修正を試みましたが、根本的な解決には至りませんでした。
2.  **拡張機能のソースコード解析:** `cell-monitor-extension/src/index.ts` を調査した結果、以下の重要な事実が判明しました。
    - 拡張機能は、設定された単一の `serverUrl` に対して、すべての種類のイベントデータを直接POSTする設計になっている。
    - パスを自動で組み立てたり、複数のエンドポイントを使い分けたりする機能は持たない。
3.  **根本原因の特定:** 問題の核心は、**「単一のエンドポイントを想定するクライアント」**と**「複数の専門エンドポイントを持つサーバー」**という設計思想のミスマッチにあると結論付けました。

## 3. 最終的なアーキテクチャ（ベストプラクティス）

このミスマッチを解消し、保守性と拡張性の高い構成を実現するため、サーバー側のアーキテクチャを全面的に改善しました。

### 統一イベントエンドポイントの導入

サーバー側に、すべてのイベントデータを受け付ける**単一の統一エンドポイント**を新設しました。

- **エンドポイント:** `POST /api/v1/events`

このエンドポイントは、拡張機能から送信されるすべてのデータ（セルの実行、ノートブックの保存など）を受け付けます。サーバーは、受信したデータに含まれる `eventType` フィールドを元に、内部で処理を振り分ける責務を負います。

これにより、**「クライアントは何も考えずに単一のURLにデータを送信し、サーバーがそのデータを賢く捌く」**という、クリーンで疎結合なアーキテクチャが実現されました。

### 利点

- **設定の簡素化:** 拡張機能の利用者は、単一のURLを設定するだけで済みます。
- **保守性の向上:** 将来的なAPIの仕様変更は、サーバー側の修正だけで完結します。
- **責務の分離:** クライアントとサーバーがそれぞれの役割に集中できます。

## 4. 設定方法

- **JupyterLab拡張機能の設定:**
  - **サーバーURL:** `http://fastapi:8000/api/v1/events`

この設定により、拡張機能は正しくサーバーと通信し、すべての進捗データが記録されます。
